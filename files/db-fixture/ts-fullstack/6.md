[prisma]: https://www.prisma.io/docs
[dbeaver]: https://dbeaver.io/
[prisma-paginate]: https://github.com/sandrewTx08/prisma-paginate
[prisma-studio]: https://www.prisma.io/studio
[source]: https://git.3rcd.com/classroom/ts-fullstack/src/branch/main/chapter6

## å¯¼è¯»

:::note

æœ¬èŠ‚è¯¾æºç : [classroom/ts-fullstack/chapter6][source]ï¼ˆè¯·[ç™»å½•](https://git.3rcd.com/user/login?redirect_to=%2f)åæŸ¥çœ‹æˆ–å…‹éš†ï¼Œå¦åˆ™ä½ å°†æ”¶åˆ°**404 NotFound**ï¼‰

:::

å­¦ä¹ å¦‚ä½•ä½¿ç”¨ next.js çš„ server action ç»“åˆ prsima orm è¿›è¡Œå…¨æ ˆå¼€å‘

### è¯¾ç¨‹ç›®æ ‡

æœ¬èŠ‚è¯¾çš„ç›®æ ‡å¦‚ä¸‹

- æŒæ¡ prisma ä¸ next.js æ•´åˆè¿›è¡Œå…¨æ ˆå¼€å‘çš„åŸºç¡€çŸ¥è¯†
- æŒæ¡ primsa çš„ç®€å•å•æ¨¡å‹ç¼–å†™ä»¥åŠæ¨¡å‹æ–‡ä»¶åˆ†å‰²
- æŒæ¡ prisma ä¸­çš„æ•°æ®è¿ç§»å’Œæ•°æ®å¡«å……çš„å®ç°
- æŒæ¡ prsima æ‰©å±•ä½¿ç”¨å’Œç®€å•æ‰©å±•çš„ç¼–å†™
- å­¦ä¼šä½¿ç”¨ prisma å¯¹æ•°æ®è¿›è¡Œæ“ä½œ
- æŒæ¡ prisma ä¸­çš„æ•°æ®åˆ†é¡µå’Œæ’åºæ–¹æ³•

### æŠ€æœ¯æ¦‚å¿µ

ä»¥ä¸‹ä¸ºæœ¬èŠ‚è¯¾æ‰€æ¶‰åŠçš„æŠ€æœ¯æ¦‚å¿µ

- [prisma][prisma]ï¼šä¸€ä¸ª node.js çš„æ•°æ®åº“ ORM
- Sqliteï¼šä¸€ç§åµŒå…¥å¼çš„å®ä½“æ–‡ä»¶æ•°æ®åº“ã€‚æŠŠæ‰€æœ‰æ•°æ®å­˜å‚¨åœ¨ä¸€ä¸ªåä¸º`xxx.db`è¿™æ ·çš„æ–‡ä»¶é‡Œï¼Œéå¸¸æ–¹ä¾¿è¿ç§»ã€‚ä¸€èˆ¬ç”¨æ¥åšæ¡Œé¢åº”ç”¨å®¢æˆ·ç«¯æ•°æ®åº“ï¼Œæœ¬è¯¾ä¸­ä¸ºäº†æ–¹ä¾¿ï¼Œç›´æ¥ç”¨ä½œæœåŠ¡ç«¯åº”ç”¨çš„æ•°æ®åº“äº†
- æ•°æ®è¿ç§»å’Œæ•°æ®å¡«å……ï¼šå¦‚æœå¯¹è¿™å—ä¸ç†Ÿæ‚‰ï¼Œå¯ä»¥é€šè¿‡[laravel çš„ç›¸å…³æ¦‚å¿µ](https://learnku.com/docs/laravel/10.x/migrations/14885)è¿›è¡Œäº†è§£
- [DBeaver](dbeaver)ï¼šä¸€ä¸ªå¼€æºä¸”å¥½ç”¨çš„æ•°æ®åº“ GUI ç®¡ç†å·¥å…·
- [prisma studio][prisma-studio]: ç”¨äº prsima orm çš„ä¸´æ—¶æŸ¥çœ‹æ•°æ®åº“æ•°æ®çš„ web æ•°æ®åº“ç®¡ç†å·¥å…·

### å‰ç½®å‡†å¤‡

åœ¨å¼€å§‹æœ¬è¯¾ç¨‹å‰ï¼Œè¯·åŠ¡å¿…é˜…è¯»ä»¥ä¸‹æ–‡æ¡£

- [prisma][prisma]çš„[Getting Started æ–‡æ¡£](https://www.prisma.io/docs/getting-started)
- [prisma][prisma]çš„[å®˜æ–¹ä½¿ç”¨æ–‡æ¡£](https://www.prisma.io/docs/orm)ï¼šä»…ç²—ç•¥é˜…è¯»ï¼Œå¤§è‡´æœ‰ä¸ªäº†è§£å³å¯
- [sqlite å…¥é—¨æ•™ç¨‹](https://www.runoob.com/sqlite/sqlite-tutorial.html)
- [laravel çš„ä¸­çš„æ•°æ®è¿ç§»å’Œæ•°æ®å¡«å……](https://learnku.com/docs/laravel/10.x/migrations/14885)

å› ä¸ºæœ¬èŠ‚è¯¾ç”¨ä¸åˆ°`src/database/db.json`è¿™ä¸ªæ–‡ä»¶äº†ï¼Œæ‰€ä»¥åšä»¥ä¸‹å·¥ä½œ

1. æŠŠåŸæ¥çš„`scripts`å‘½ä»¤æ”¹å›æ¥`"dev": "rimraf -rf .next && next dev --turbopack",`
2. åœ¨ eslint è§„åˆ™ä¸­æŠŠå®ƒå»æ‰

ç„¶ååˆ é™¤`src/database/generator.ts`æ–‡ä»¶

## prsima

è¿™èŠ‚è¯¾çš„ä¸»è¦ç›®çš„æ˜¯å­¦ä¼š prisma åœ¨ next.js ä¸­çš„åŸºæœ¬ä½¿ç”¨ï¼Œæ‰€ä»¥ä¸“æ³¨äºç‰Ÿæ˜Ÿå’Œæ•°æ®ç»“æ„æ–¹é¢ã€‚ä¸‹èŠ‚è¯¾æˆ‘ä»¬å†è¯¦ç»†åœ°ä½¿ç”¨å®ƒçš„ api æ“ä½œæ•°æ®å¹¶ä½¿ç”¨ zod è¿›è¡Œæ•°æ®éªŒè¯

### vscode æ’ä»¶

åœ¨ä½¿ç”¨ prisma å‰ï¼Œå…ˆå®‰è£…ä¸€ä¸‹å®ƒçš„[vscode æ’ä»¶](https://marketplace.visualstudio.com/items?itemName=Prisma.prisma)ã€‚è¯¥æ’ä»¶çš„é…ç½®ä¸ç”¨å…³æ³¨ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨ç¬¬ä¸€èŠ‚çš„æ—¶å€™å·²ç»åœ¨æºç ä¸­å¤åˆ¶å¥½äº† ğŸ˜„ã€‚å¦‚æœæ²¡æœ‰çš„è¯è¯·è‡ªè¡Œå¤åˆ¶ä¸€ä¸‹

```json
// .vscode/settings.json
{
    "editor.formatOnSave": false,
    // ...
    "[prisma]": {
        "editor.defaultFormatter": "Prisma.prisma",
        "editor.formatOnSave": true
    }
    // ...
}
```

### åˆå§‹åŒ–

ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åˆå§‹åŒ–ä¸€ä¸‹ prisma

:::info

ä¸ºäº†ç®€å•ï¼Œè¿™é‡Œä½¿ç”¨ sqlite ä½œä¸ºæ•°æ®åº“ã€‚åç»­æˆ‘ä»¬å­¦ä¹ åˆ° nestjs æ—¶å†ä½¿ç”¨ç”Ÿäº§ç¯å¢ƒä¸‹ä½¿ç”¨çš„ mysql å’Œ postgresql è¿™äº›

:::

```bash
pnpm i prisma@latest -D # å®‰è£…prisma
pnpm prisma init --datasource-provider sqlite # åˆå§‹åŒ–prisma, --datasource-provider sqlite ç”¨äºæŒ‡å®šæ•°æ®åº“é©±åŠ¨
pnpm prisma migrate dev --name init --skip-generate # ç”Ÿæˆæ•°æ®åº“ï¼Œè¯¥å‘½ä»¤å…¶å®æ˜¯ç”¨æ¥åˆ›å»ºå¹¶è¿è¡Œè¿ç§»çš„ï¼Œä½†æ˜¯ç›®å‰æˆ‘ä»¬æ²¡æœ‰æ¨¡å‹ã€‚æ‰€ä»¥åŠ ä¸Š--skip-generateå‚æ•°ä»…ç”¨äºç”Ÿæˆæ•°æ®åº“
```

å¯ä»¥çœ‹åˆ°ç›®å‰ç”Ÿæˆäº†ä»¥ä¸‹æ–‡ä»¶ç»“æ„

```bash
prisma
â”œâ”€â”€ dev.db # æ•°æ®åº“æ–‡ä»¶
â”œâ”€â”€ dev.db-journal # æ•°æ®åº“æ“ä½œä¸´æ—¶æ—¥å¿—æ–‡ä»¶
â””â”€â”€ schema.prisma # primsaæ•°æ®åº“å®¢æˆ·ç«¯é…ç½®
```

`prisma/schema.prisma`çš„é»˜è®¤é…ç½®å¦‚ä¸‹

```json
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}
```

### æ•°æ®æ¨¡å‹

æ¨¡å‹ç”¨äºæ˜ å°„æ•°æ®åº“è¡¨ç»“æ„ã€‚prisma ä¸å¤§å¤šæ•° ORM ä¸€æ ·ï¼Œé€šè¿‡æ¨¡å‹æ¥æ“ä½œæ•°æ®ã€‚ä¸ä¸Šä¸€èŠ‚å¯¹åº”ï¼Œæ·»åŠ ä¸€ä¸ªæ–‡ç« æ¨¡å‹ã€‚å¯¹äºæå°çš„åº”ç”¨ï¼ŒæŠŠæ‰€æœ‰æ¨¡å‹çš„å®šä¹‰ç›´æ¥æ”¾åˆ°`prisma/schema.prisma`ä¸‹é¢å³å¯

å¦‚ä¸‹

```json
// prisma/schema.prisma
// ...
model Post {
    id        String   @id @default(uuid())
    thumb     String
    title     String
    summary   String?
    body      String
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@map("posts")
}
```

éšç€é¡¹ç›®çš„é€æ¸å˜å¤§ï¼ˆè™½ç„¶æœ¬ç¯‡ç« çš„è¯¾ç¨‹å°±ä¸€ä¸ªæ¨¡å‹^v^ï¼‰ï¼ŒæŠŠæ‰€æœ‰æ¨¡å‹å†™åœ¨ä¸€ä¸ªé¡¶å±‚çš„`schema.primsa`ä¸­æ˜¾ç„¶ä¸åˆå¸¸ç†ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æŠŠæ¯ä¸ªæˆ–è€…å‡ ä¸ªç›¸å…³çš„æ¨¡å‹å†™åœ¨ä¸€ä¸ªæ–‡ä»¶é‡Œã€‚åœ¨ä»¥å‰ï¼Œè¿™éœ€è¦é€šè¿‡ç¬¬ä¸‰æ–¹çš„æ‰©å±•æ¥å®ç°ã€‚ä½†ç°åœ¨ prisma å®˜æ–¹å·²ç»æ”¯æŒè¿™ä¸ªåŠŸèƒ½äº†ã€‚

è¿™æ˜¯ä¸€ä¸ªé¢„è§ˆæ€§èƒ½ï¼Œå…·ä½“å¯ä»¥çœ‹[å®˜æ–¹æ–‡æ¡£](https://www.prisma.io/docs/orm/prisma-schema/overview/location)ã€‚æˆ‘ä»¬åªéœ€è¦éå¸¸ç®€å•çš„åœ¨`previewFeatures`ä¸­å¯ç”¨å³å¯

å¦‚ä¸‹

```json
// prisma/schema.prisma
// ...
generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["prismaSchemaFolder"]
}
```

ç„¶åå°±å¯ä»¥æŠŠæ¨¡å‹ä»£ç æ”¾åˆ°å…¶ä»–æ–‡ä»¶ä¸­äº†

æ–°å¢ä¸€ä¸ª`prisma/post.prisma`æ–‡ä»¶ï¼ŒæŠŠ`prisma/schema.prisma`ä¸­çš„**æ¨¡å‹ä»£ç **æ”¾è¿›å»å³å¯

### æ–‡ä»¶ç»“æ„

ç°åœ¨æœ‰ä»¥ä¸‹å‡ ä¸ªé—®é¢˜

- å› ä¸ºåç»­æ¶‰åŠåˆ° prisma æ‰©å±•å’Œå®¢æˆ·ç«¯è¿æ¥ç­‰ä»£ç ï¼Œè€Œè¿™äº›ä»£ç éƒ½æ˜¯ç”¨ TS å†™çš„ï¼Œè€Œè¿™äº›ä»£ç ä¸€èˆ¬å’Œæ¨¡å‹æ–‡ä»¶éƒ½æ”¾ä¸€èµ·ã€‚æ‰€ä»¥å¦‚æœæŠŠ`prisma`ç›®å½•æ”¾åœ¨é¡¶å±‚ï¼Œåˆ™å¿…é¡»è¦åœ¨`tsconfig.json`å’Œ`tsconfig.eslint.json`å¢åŠ `prisma`è¿™ä¸ªç›®å½•ï¼Œæ˜¾å¾—éå¸¸ä¸åˆç†
- ç›®å‰ä½¿ç”¨çš„ sqlite æ•°æ®åº“ã€‚ä½† sqlite æ•°æ®åº“æ˜¯ä¸€ä¸ªå®ä½“çš„äºŒçº§åˆ¶æ–‡ä»¶ï¼Œæ¯”å¦‚ç°åœ¨çš„`dev.db`ã€‚è¿™ä¸ªæ–‡ä»¶å’Œä»£ç æ”¾åœ¨ä¸€èµ·æ¯”è¾ƒå½±å“é¡¹ç›®çš„æ•´ä½“æ–‡ä»¶ç»“æ„

é’ˆå¯¹ä»¥ä¸Šä¸¤ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦è°ƒæ•´ä¸€ä¸‹æ–‡ä»¶ç»“æ„

1. åˆ›å»º`src/database/schema`ç›®å½•ï¼ŒæŠŠ`prisma/schema.prisma`å’Œ`prisma/post.prisma`æ”¾è¿›å»
2. æŠŠ`prisma/dev.db`å’Œ`prisma/dev.db-journal`ç§»åŠ¨åˆ°æ ¹ç›®å½•
3. åˆ é™¤`prisma`ç›®å½•
4. åœ¨`package.json`ä¸­è®¾å®šè‡ªå®šçš„ prisma æ¨¡å‹ç›®å½•ä¸º`src/database/schema`

```json
// package.json
{
    // ...
    "prisma": {
        "schema": "src/database/schema"
    }
}
```

5. å› ä¸ºåªæœ‰å½“`DATABASE_URL`åœ¨ schema ç›®å½•ä¸‹æ—¶ï¼Œå®¢æˆ·ç«¯å’Œè¿ç§»æ‰éƒ½å¯ä»¥æ‰¾åˆ°æ­£ç¡®çš„ sqlite æ•°æ®åº“æ–‡ä»¶è·¯å¾„ã€‚è€Œæˆ‘ä»¬ç°åœ¨æŠŠæ•°æ®åº“æ–‡ä»¶ç§»åŠ¨åˆ°äº†æ ¹ç›®å½•ï¼Œæ‰€ä»¥éœ€è¦ä¿®æ”¹`.env`æ–‡ä»¶ï¼ŒæŠŠæ•°æ®åº“è·¯å¾„æ”¹æˆç»å¯¹è·¯å¾„ï¼ˆå¦‚`DATABASE_URL="file:/Users/pincman/Code/nextapp/dev.db"`ï¼‰ï¼Œ**ä½ å¯ä»¥åœ¨ vscode ä¸­å³é”®`dev.db`è·å–å®ƒçš„ç»å¯¹è·¯å¾„**ã€‚å› ä¸ºæ•°æ®åº“æ–‡ä»¶çš„è·¯å¾„æ˜¯`src/database/schema`çš„ç›¸å¯¹è·¯å¾„ï¼Œè€Œåœ¨å®¢æˆ·ç«¯è¿æ¥æ—¶æ˜¯ä»æ ¹ç›®å½•æŸ¥æ‰¾çš„ï¼Œæ‰€ä»¥ä¼šç›´æ¥å¯¼è‡´æ‰¾ä¸åˆ°æ•°æ®åº“ã€‚

ç°åœ¨çš„æ–‡ä»¶ç»“æ„å¦‚ä¸‹

```bash
.
â”œâ”€â”€ dev.db
â”œâ”€â”€ dev.db-journal
â”œâ”€â”€ .env
â”œâ”€â”€ public
â”œâ”€â”€ src
â”‚   â”œâ”€â”€ app
â”‚   â”œâ”€â”€ database
â”‚   â”‚   â”œâ”€â”€ db.json
â”‚   â”‚   â”œâ”€â”€ generator.ts
â”‚   â”‚   â”œâ”€â”€ schema
â”‚   â”‚   â”‚   â”œâ”€â”€ post.prisma
â”‚   â”‚   â”‚   â””â”€â”€ schema.prisma
â”‚   â”‚   â”œâ”€â”€ types.ts
â”‚   â”‚   â””â”€â”€ utils.ts
â”‚   â””â”€â”€ libs
â””â”€â”€ ...
```

### æ•°æ®è¿ç§»

å½“ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬è¿˜æ²¡æœ‰ç”Ÿæˆæ•°æ®ç»“æ„ï¼Œæ‰€ä»¥æ— æ³•æ“ä½œæ•°æ®ã€‚æˆ‘ä»¬å¯ä»¥å…ˆé€šè¿‡ä»¥ä¸‹æ–¹å¼ç”Ÿæˆæ•°æ®è¡¨ç»“æ„

1. ä½¿ç”¨`migrate`å‘½ä»¤æ¥ç”Ÿæˆæ•°æ®è¿ç§»æ–‡ä»¶ï¼Œè¿™äº›ç”Ÿæˆçš„ sql æ–‡ä»¶å¯ä»¥ç”¨æ¥ç”Ÿæˆä»¥åŠåŒæ­¥æ•°æ®è¡¨ç»“æ„ã€‚åœ¨å¼€å‘ç¯å¢ƒä¸­ä¿®æ”¹ schema æ¨¡å‹åï¼Œå¯ä»¥é€šè¿‡é‡æ–°ç”Ÿæˆè¿ç§»ï¼Œç„¶ååŒæ­¥è¡¨ç»“æ„è¿™æ ·å°±ä¸ä¼šç ´åç”Ÿäº§ç¯å¢ƒä¸­çš„æ•°æ®äº†
2. åŒæ­¥è¡¨ç»“æ„ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä»¬éœ€è¦ç”¨åˆ°`push`å‘½ä»¤æŠŠä¿®æ”¹çš„æ¨¡å‹æ¨é€åˆ°è¡¨ç»“æ„ä»¥ä½¿æ•°æ®æ¨¡å‹å’Œæ•°æ®è¡¨ç»“æ„åŒæ­¥ã€‚ä½†æ˜¯ï¼Œå¦‚æœå·²ç»å­˜åœ¨ä¸€ä¸ªæ•°æ®åº“ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨`pull`å‘½ä»¤æ¥åå‘é€šè¿‡è¡¨ç»“æ„ç”Ÿæˆæ¨¡å‹
3. æ•°æ®æ¨¡å‹å’Œæ•°æ®åº“è¡¨ç»“æ„åŒæ­¥åï¼Œæˆ‘ä»¬è¿˜éœ€è¦æ“ä½œæ•°æ®ã€‚ä½†æ˜¯ï¼Œå› ä¸º prisma ä¸åƒ typeorm è¿™äº›é€šè¿‡ ts ç›´æ¥å®šä¹‰æ¨¡å‹çš„ ORMï¼Œè€Œæ˜¯é€šè¿‡ schema æ¥å®šä¹‰çš„ã€‚æ‰€ä»¥ï¼Œå®šä¹‰å¥½æ¨¡å‹åï¼Œæ•°æ®æ“ä½œçš„æ–¹æ³•å’Œç±»å‹æ˜¯ä¸å­˜åœ¨çš„ã€‚`generate`å‘½ä»¤å°±æ˜¯ç”¨æ¥é€šè¿‡å®šä¹‰çš„ schema æ¨¡å‹ç”Ÿæˆç”¨äºæ•°æ®æ“ä½œçš„ ts æ–¹æ³•å’Œç±»å‹çš„ã€‚è¿™äº›ç”Ÿæˆçš„ ts æ–¹æ³•å’Œç±»å‹ä¼šå­˜åœ¨äº`node_modules`ä¸­ï¼Œè€Œæˆ‘ä»¬æäº¤ä»£ç åˆ°ä»“åº“åï¼Œ`node_modules`æ˜¯ ignore çš„ã€‚æ‰€ä»¥ç”Ÿäº§ç¯å¢ƒä¸‹ï¼Œåœ¨æ¯æ¬¡éƒ¨ç½²å®Œåæˆ‘ä»¬è¿˜éœ€è¦è¿è¡Œè¿™ä¸ªå‘½ä»¤æ¥ç”Ÿæˆä¸€ä¸‹ ts ç›¸å…³çš„ä¸œè¥¿

å¯¹äºä»¥ä¸Šä¸‰ä¸ªæ­¥éª¤ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ä¸‰ä¸ªå‘½ä»¤ä¸€æ­¥æ­¥å®ç°

é¦–å…ˆç”Ÿæˆè¿ç§»

```bash
pnpm prisma migrate dev --create-only --skip-generate --name init
```

å¯ä»¥çœ‹åˆ°ç”Ÿæˆäº†ä»¥ä¸‹ SQL æ–‡ä»¶

![](https://cn-nb1.rains3.com/3rcd/media/1735764458079.png)

ç„¶åè¿è¡Œè¿ç§»

```bash
pnpm prisma db push
```

å¯ä»¥ä½¿ç”¨ navicat/vscode çš„ sqlite æ’ä»¶/[DBeaver][dbeaver]ç­‰å·¥å…·æ¥ç®¡ç†æ•°æ®åº“ã€‚ä»¥[DBeaver][dbeaver]ä¸ºä¾‹ï¼Œå¯ä»¥çœ‹åˆ°ç”Ÿæˆå¦‚ä¸‹æ•°æ®ç»“æ„

:::info

å…¶ä¸­`_prisma_migrations`æ˜¯è‡ªåŠ¨ç”Ÿæˆçš„è¡¨ï¼Œç”¨äºè®°å½•æ•°æ®åº“è¿ç§»æ—¥å¿—

:::

![](https://cn-nb1.rains3.com/3rcd/media/1735763223069.png)

æœ€åï¼Œéœ€è¦ä½¿ç”¨`generate`å‘½ä»¤ç”Ÿæˆ ts ç±»å‹å’Œæ–¹æ³•ï¼Œå¹¶é‡è½½ vscode çª—å£

```bash
pnpm prisma generate
```

å¦å¤–ï¼Œå…¶å®ä¸Šé¢çš„æ‰€æœ‰å‘½ä»¤å¯ä»¥ç›´æ¥æ•´åˆä¸ºä¸€æ¡å‘½ä»¤ã€‚å¦‚ä¸‹å‘½ä»¤æ‰€ç¤ºï¼Œç›´æ¥ä½¿ç”¨`pnpm prisma migrate dev`å‘½ä»¤å³å¯å®ç°ç”Ÿæˆè¿ç§»ã€è¿è¡Œè¿ç§»ã€ç”Ÿæˆ TS ä¸‰ä¸ªåŠŸèƒ½

```bash
pnpm prisma migrate dev --name update
```

ç„¶åï¼Œæ¯å½“æˆ‘ä»¬æ¨¡å‹å®šä¹‰æœ‰æ”¹å˜ï¼Œæ¯”å¦‚ä¿®æ”¹å­—æ®µï¼Œæ–°å¢æ¨¡å‹ç­‰ã€‚å°±éœ€è¦ä½¿ç”¨ä»¥ä¸Šä¸‰ä¸ªå‘½ä»¤æ¥åŒæ­¥æ•°æ®åº“ï¼Œæˆ–è€…åªä½¿ç”¨`migrate`å‘½ä»¤ä¸€æ¡ä¹Ÿå¯ä»¥

å¦å¤–ï¼Œä¸ºäº†æ–¹ä¾¿èµ·è§ï¼Œæˆ‘ä»¬ä¸ºè¿™äº›å‘½ä»¤æ·»åŠ ä¸€äº›ç®€ç§°

å®‰è£…ç¯å¢ƒå˜é‡è®¾ç½®åº“ï¼Œè¯¥åº“ç”¨äº node ä¸­è·¨å¹³å°è®¾ç½®ç¯å¢ƒå˜é‡

```bash
pnpm add cross-env -D
```

åœ¨`package.json`ä¸­æ·»åŠ å¦‚ä¸‹è„šæœ¬

```json
{
    "scripts": {
        // ...
        "------------------ db command": "----",
        "dbg": "cross-env NODE_ENV=development prisma generate",
        "dbp": "cross-env NODE_ENV=development prisma db push",
        "dbmc": "cross-env NODE_ENV=development prisma migrate dev --create-only --skip-generate",
        "dbm": "cross-env NODE_ENV=development prisma migrate dev",
        "dbmr": "cross-env NODE_ENV=development prisma migrate reset -f",
        "dbmd": "cross-env NODE_ENV=production prisma migrate deploy"
    }
}
```

æ·»åŠ äº†ä»¥ä¸‹å‘½ä»¤

- `dbg`ï¼šç”Ÿæˆ ts æ–‡ä»¶ï¼ˆæ•°æ®æ“ä½œçš„ç±»å‹ã€æ–¹æ³•ç­‰ï¼‰
- `dbp`ï¼šæŠŠè¿ç§»ä¸­çš„ sql æ¨é€ï¼ˆåŒæ­¥ï¼‰åˆ°æ•°æ®åº“
- `dbmc`ï¼šç”Ÿæˆç”¨äºè¿ç§»çš„ sql æ–‡ä»¶
- `dbm`ï¼šç”¨äºç”Ÿæˆè¿ç§»æ–‡ä»¶ã€è¿è¡Œè¿ç§»ã€ç”Ÿæˆ ts æ–‡ä»¶
- `dbmr`ï¼šé‡ç½®æ•°æ®åº“ï¼Œä¹Ÿå°±æ˜¯åˆ é™¤ç°æœ‰çš„è¡¨ç»“æ„ï¼Œç„¶åä½¿ç”¨è¿ç§»æ–‡ä»¶é‡æ–°ç”Ÿæˆã€‚è€Œä¸æ˜¯åœ¨åŸæœ‰æ•°æ®åº“ç»“æ„çš„åŸºç¡€ä¸Šé€šè¿‡åˆå¹¶è¿ç§»çš„æ–¹å¼ä¿®æ”¹æ•°æ®åº“ï¼ˆè¿™ä¸ªå‘½ä»¤ç”Ÿäº§ç¯å¢ƒä¸‹ä¸¥ç¦ä½¿ç”¨ï¼Œç›¸å½“äºç›´æ¥åˆ é™¤æ‰€æœ‰æ•°æ®è¡¨ï¼Œå¯¼è‡´æ•°æ®ä¸¢å¤±ï¼ï¼‰
- `dbmd`ï¼š åœ¨ç”Ÿæˆç¯å¢ƒä¸‹è¿è¡Œæ‰€æœ‰è¿ç§»ä»è€ŒæŠŠæ•°æ®åº“è¡¨ç»“æ„æ›´æ–°åˆ°æœ€æ–°çš„è¿ç§»

ç°åœ¨ä½ å¯ä»¥é€šè¿‡`pnpm dbm --name=update`ç­‰å‘½ä»¤æ¥æ›¿ä»£ä¸Šé¢çš„é•¿å‘½ä»¤äº†

### æ•°æ®å¡«å……

åƒä¸Šä¸€èŠ‚è¯¾ä¸€æ ·ï¼Œä¸ºäº†æ–¹ä¾¿å±•ç¤ºï¼Œæˆ‘ä»¬ä¸ºæ•°æ®åº“ä¸­æ³¨å…¥ä¸€äº›å‡æ•°æ®ã€‚åœ¨æ•°æ®åº“ç¯å¢ƒä¸‹è¿™ä¸ªæ“ä½œå«åšâ€œæ•°æ®å¡«å……â€ã€‚prisma çš„å¤§å¤šæ•° ORM éƒ½å¯ä»¥è½»æ˜“çš„å®ç°æ•°æ®å¡«å……

å®‰è£… ts-node ç”¨äºæ‰§è¡Œ ts æ–‡ä»¶

:::info

æˆ–è€…ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ bun å»æ‰§è¡Œï¼Œä¸è¿‡å°†æ¥çš„æ–°ç‰ˆ node å¤§æ¦‚ç‡å¯ä»¥åŸç”Ÿæ”¯æŒç›´æ¥æ‰§è¡Œ ts äº†

:::

:::note

`tsconfig-paths`ç”¨äºæ·»åŠ è·¯å¾„æ˜ å°„ï¼Œå¦åˆ™ä¼šæ‰¾ä¸åˆ°`@/`å¼€å¤´çš„æ¨¡å—è·¯å¾„ï¼Œæ¯”å¦‚`import { getRandomInt } from '@/libs/random';`ã€‚å¦‚æœä½¿ç”¨ bun åˆ™ä¸éœ€è¦

:::

```bash
pnpm add ts-node tsconfig-paths -D
```

åœ¨`package.json`ä¸­æ·»åŠ `prisma.seed`å­—æ®µæŒ‡å®šå¡«å……çš„æ‰§è¡Œå‘½ä»¤ï¼Œç„¶ååœ¨`scripts`æ·»åŠ å¡«å……è„šæœ¬å‘½ä»¤

```json
{
    "scripts": {
        // ...
        "dbs": "prisma db seed"
    },
    "prisma": {
        "schema": "src/database/schema",
        "seed": "ts-node --compiler-options {\"module\":\"CommonJS\"} -r tsconfig-paths/register src/database/seed/index.ts"
    }
}
```

ç”±äºé»˜è®¤æƒ…å†µä¸‹çš„åœ¨`migrate`å’Œ`reset`å‘½ä»¤æ—¶ï¼Œå¦‚æœæœ‰é…ç½®`prisma.seed`çš„å¡«å……å‘½ä»¤ï¼Œåˆ™è‡ªåŠ¨ä¼šæ‰§è¡Œã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬éœ€è¦åœ¨`package.json`ä¸­åˆ†å‰²è¿™ä¸¤ä¸ªå‘½ä»¤ï¼Œä»¥ä¾¿å¯ä»¥é€‰æ‹©å¡«å……æˆ–ä¸å¡«å……ï¼Œå¦‚ä¸‹ï¼Œä½¿ç”¨`--skip-seed`å‚æ•°è·³è¿‡å¡«å……

```json
{
    "scripts": {
        // ...
        "------------------ db command": "----",
        "dbg": "cross-env NODE_ENV=development prisma generate",
        "dbp": "cross-env NODE_ENV=development prisma db push",
        "dbmc": "cross-env NODE_ENV=development prisma migrate dev --create-only --skip-generate",
        "dbm": "cross-env NODE_ENV=development prisma migrate dev --skip-seed",
        "dbmr": "cross-env NODE_ENV=development prisma migrate reset -f --skip-seed",
        "dbms": "cross-env NODE_ENV=development prisma migrate dev",
        "dbmrs": "cross-env NODE_ENV=development prisma migrate reset -f",
        "dbs": "prisma db seed",
        "dbmd": "cross-env NODE_ENV=production prisma migrate deploy"
    }
}
```

#### å®¢æˆ·ç«¯

åˆ›å»ºä¸€ä¸ª prisma å®¢æˆ·ç«¯å®ä¾‹ï¼Œç”¨äºè¿æ¥å’Œæ“ä½œæ•°æ®åº“

```typescript
// src/database/client.ts
import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();

export { prisma };
```

#### å¡«å……å‡½æ•°

å…¶å®å¡«å……å°±æ˜¯ä½¿ç”¨ prisma client çš„ api å¯¹æ•°æ®åº“æ³¨å…¥ä¸€äº›å‡æ•°æ®è€Œå·²ã€‚è¿™ä¸ä¸Šä¸€èŠ‚çš„åˆ é™¤`db.json`çš„æ“ä½œä½œç”¨æ˜¯ä¸€æ ·çš„ã€‚

1. æ·»åŠ `src/database/seed/post.ts`æ–‡ä»¶ï¼Œç”¨äºç¼–å†™å¡«å……é€»è¾‘
2. æ·»åŠ `src/database/seed/index.ts`æ–‡ä»¶ï¼Œæ‰§è¡Œæ‰€æœ‰å¡«å……é€»è¾‘

å¡«å……å‡½æ•°çš„æ•°æ®ç”Ÿæˆæ–¹å¼ä¸ä¸Šä¸€èŠ‚è¯¾çš„`src/database/generator.ts`ä¸­çš„å‡æ•°æ®ç”Ÿæˆæ–¹å¼å‡ ä¹ä¸€æ ·ã€‚

ä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯,ç›®å‰æˆ‘ä»¬å·²ç»åœ¨æ“ä½œæ•°æ®åº“äº†ï¼Œæ‰€ä»¥`id`åœ¨æ’å…¥æ•°æ®çš„æ—¶å€™æ˜¯ç”±æ•°æ®åº“è‡ªåŠ¨ç”Ÿæˆçš„ï¼Œä¸éœ€è¦åœ¨ç”Ÿæˆæ•°æ®å‰æ·»åŠ `id`

```typescript
// src/database/seed/post.ts
import { getRandomInt } from '@/libs/random';

import { prisma } from '../client';
import { faker } from '../utils';

export const createPostData = async () => {
    // ä¸ºé¿å…é‡å¤æ·»åŠ æ•°æ®ï¼Œåœ¨é‡æ–°è¿è¡Œæ•°æ®å¡«å……æ—¶ï¼Œæ¸…ç©ºå·²æœ‰æ–‡ç« æ•°æ®
    await prisma.post.deleteMany();
    for (let index = 0; index < 22; index++) {
        await prisma.post.create({
            select: { id: true },
            data: {
                // éšæœºå°é¢å›¾
                thumb: `/uploads/thumb/post-${getRandomInt(1, 8)}.png`,
                // ç”Ÿæˆ1åˆ°3ä¸ªæ®µè½çš„æ ‡é¢˜
                title: faker.lorem.paragraph({ min: 1, max: 3 }),
                // ç”Ÿæˆ3-6ä¸ªæ®µè½çš„å†…å®¹å¹¶æŠŠæ¯ä¸ªæ®µè½ç”¨æ¢è¡Œç¬¦æ¢è¡Œ
                body: faker.lorem.paragraphs(getRandomInt(3, 6), '\n'),
                // æœ‰49%çš„æœºç‡ä¼šç”Ÿæˆä¸€æ®µæ‘˜è¦
                summary: Math.random() < 0.5 ? faker.lorem.text() : undefined,
            },
        });
    }
};
```

ç¼–å†™å¡«å……å…¥å£æ–‡ä»¶å¹¶è°ƒç”¨å¡«å……å‡½æ•°

```typescript
// src/database/seed/index.ts
import { prisma } from '../client';

import { createPostData } from './post';

async function seed() {
    try {
        await createPostData();
    } catch (e) {
        console.error(e);
        process.exit(1);
    }
    await prisma.$disconnect();
    process.exit();
}

seed();
```

ç°åœ¨æ‰§è¡Œ`pnpm dbs`æˆ–`pnpm dbms`å°±å¯ä»¥å¡«å……å‡æ•°æ®äº†ï¼Œä½¿ç”¨ DBeaver æŸ¥çœ‹ä¸€ä¸‹æ•°æ®è¡¨ï¼Œå‘ç°å·²ç»æœ‰æ•°æ®äº†

![](https://cn-nb1.rains3.com/3rcd/media/1735763223079.png)

### æ‰©å±•ä½¿ç”¨

åœ¨ä¸Šé¢çš„æ•°æ®å¡«å……åŠŸèƒ½ä¸­ï¼Œå¦‚æœæ²¡æœ‰åœ¨è¿è¡Œå‰æ¸…ç©ºæ•°æ®è¡¨ã€‚é‚£ä¹ˆå¤šæ¬¡è¿è¡Œä¼šä½¿æ•°æ®è¡¨ä¸æ–­è†¨èƒ€ï¼Œå¹¶ä¸”å¦‚æœæ•°æ®è¡¨ä¸­æœ‰å”¯ä¸€å€¼å­—æ®µï¼Œè€Œä¸”ä¸¤æ¬¡æ³¨å…¥çš„å€¼æ˜¯ç›¸åŒçš„ï¼Œé‚£ä¹ˆå¯¼è‡´å”¯ä¸€å€¼æŠ¥é”™ã€‚è¿™æ—¶ï¼Œæˆ‘ä»¬ä¸å¾—ä¸ä½¿ç”¨`createOrUpdate`è¿™ç§ API è¿›è¡Œåˆ¤æ–­æ•°æ®æ˜¯å¦å·²å­˜åœ¨ï¼Œæˆ–è€…å°±åƒä¸Šé¢çš„ä»£ç ä¸€æ ·ä½¿ç”¨`deleteMany`å»ä½æ€§èƒ½çš„åˆ é™¤æ‰€æœ‰æ•°æ®ï¼ˆä½†å¦‚æœæ˜¯`Int`ç±»å‹çš„`id`ï¼Œåˆ™æ— æ³•æ¸…é™¤è‡ªå¢ï¼‰ã€‚æ‰€ä»¥ï¼Œæœ€å¥½çš„æ–¹å¼å°±æ˜¯åœ¨æ‰§è¡Œå¡«å……å‘½ä»¤å‰ï¼Œä½¿ç”¨`truncate`æ¸…ç©ºæ•°æ®è¡¨è®°å½•ã€‚è€Œ prisma æ²¡æœ‰è‡ªå¸¦è¿™ä¸ªåŠŸèƒ½ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬éœ€è¦è‡ªè¡Œç¼–å†™ä¸€ä¸ªæ‰©å±•æ·»åŠ è¯¥åŠŸèƒ½

ä½†ç”±äºç¯‡å¹…ä¼˜å…ˆï¼Œç¼–å†™ Prisma æ‰©å±•çš„æ–¹æ³•ä¹Ÿå·²ç»è¶…å‡ºäº†æœ¬èŠ‚è¯¾çš„å†…å®¹èŒƒç•´ï¼Œå¯è‡ªè¡ŒæŸ¥çœ‹[å®˜æ–¹æ–‡æ¡£](https://www.prisma.io/docs/orm/prisma-client/client-extensions)ã€‚äº‹å®ä¸Šæ²¡æœ‰ç‰¹æ®Šéœ€æ±‚å¤§å¤šæ•°æ—¶å€™æ²¡å¿…è¦å†™æ‰©å±•ï¼Œå¤§éƒ¨åˆ†ä½ éœ€è¦çš„æ•°æ®åº“åŠŸèƒ½ï¼Œprisma æˆ–è‡ªå¸¦æˆ–å·²ç»ç”±ç¬¬ä¸‰æ–¹æ‰©å±•äº†ã€‚æ­£å¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åªè¦å­¦ä¼šå¦‚ä½•ä½¿ç”¨æ‰©å±•å³å¯

å°±åƒè¿™ä¸ª`truncate`çš„å°æ‰©å±•ä¹Ÿå¹¶ä¸æ˜¯ç«™é•¿è‡ªå·±å†™çš„ï¼Œè€Œæ˜¯ä»[prisma-extensions](https://prisma-extensions.io/)ï¼ˆè¿™ä¸ªå·²ç»ä¸ç»´æŠ¤äº†ï¼‰çš„[æºç ](https://git.3rcd.com/classroom/ts-fullstack/src/branch/main/basic/chapter7/src/database/extensions/truncate)é‡Œå¤åˆ¶ä¸‹æ¥ï¼Œæ”¾å…¥`src/database/extensions`ç›®å½•ã€‚ç„¶åä¿®æ”¹ä¸€ä¸‹ï¼Œä½¿å…¶åŒ¹é…æœ€æ–°ç‰ˆçš„ prisma æ‰©å±•å†™æ³•å³å¯

æœ‰äº†æ‰©å±•åï¼Œæˆ‘ä»¬åœ¨å®¢æˆ·ç«¯é‡Œæ·»åŠ è¯¥æ‰©å±•ï¼Œå¦‚ä¸‹

```typescript
// src/database/client.ts
import { PrismaClient } from '@prisma/client';

import { truncateExt } from './extensions/truncate';

const prisma = new PrismaClient().$extends(
    truncateExt('sqlite', {
        resetSequence: false,
    }),
);

export { prisma };
```

ç°åœ¨ï¼Œå°±å¯ä»¥è¯¥æ‰©å±•äº†ã€‚ä¿®æ”¹` await prisma.post.deleteMany();`ä¸º`await prisma.post.$truncate();`

```typescript
// src/database/seed/post.ts
// ...
export const createPostData = async () => {
    // ä¸ºé¿å…é‡å¤æ·»åŠ æ•°æ®ï¼Œåœ¨é‡æ–°è¿è¡Œæ•°æ®å¡«å……æ—¶ï¼Œæ¸…ç©ºå·²æœ‰æ–‡ç« æ•°æ®
    await prisma.post.$truncate();
    // ...
};
```

é‡æ–°è¿è¡Œ`pnpm dbs`å¯ä»¥çœ‹åˆ°æ—§æ•°æ®æˆåŠŸè¢«æ¸…ç©ºåæ‰å¡«å……æ–°æ•°æ®

### Prisma studio

[prisma studio][prisma-studio]æ˜¯ä¸€ä¸ªé…åˆ prisma çš„åœ¨çº¿æ•°æ®åº“é¢„è§ˆå·¥å…·ï¼Œåœ¨`package.json`ä¸­æ·»åŠ å‘½ä»¤å°±å¯ä»¥ä½¿ç”¨å®ƒäº†

```json
{
    "scripts": {
        // ...
        "dbo": "prisma studio"
    }
}
```

è¿è¡Œ`pnpm dbo`å¹¶æ‰“å¼€ [http://localhost:5555](http://localhost:5555) çœ‹ä¸€ä¸‹æ•ˆæœ

![](https://cn-nb1.rains3.com/3rcd/media/1735763223110.png)

## æ”¹é€ åº”ç”¨

ç°åœ¨æˆ‘ä»¬æ¥æ”¹é€ ä¸Šä¸€èŠ‚è¯¾çš„åº”ç”¨æ•°æ®æ“ä½œä»£ç ã€‚æ”¹å˜ä½¿ç”¨ json å­˜å–æ•°æ®çš„æ–¹å¼ä¸ºä½¿ç”¨ prisma orm æ¥é€šè¿‡æ•°æ®åº“æ¥å­˜å–æ•°æ®

### åº”ç”¨å®¢æˆ·ç«¯

å‰é¢çš„ prisma å®¢æˆ·ç«¯ï¼ˆå³ï¼š`src/database/client.ts`ï¼‰æ˜¯ç”¨äºæ•°æ®è¿ç§»å’Œæ•°æ®å¡«å……æ—¶ä½¿ç”¨çš„ prisma å®¢æˆ·ç«¯çš„ã€‚è€Œå¯¹äºåº”ç”¨çš„æ•°æ®æ“ä½œï¼Œéœ€è¦å•ç‹¬ç¼–å†™ä¸€ä¸ª prisma å®¢æˆ·ç«¯ã€‚å› ä¸ºï¼Œä»–ä»¬çš„æ‰©å±•æ˜¯ä¸ä¸€æ ·çš„ã€‚æ¯”å¦‚åº”ç”¨çš„å®¢æˆ·ç«¯éœ€è¦æ·»åŠ ä¸€ä¸ªåˆ†é¡µæ‰©å±•ï¼Œä½†æ˜¯ä¸ºäº†å®‰å…¨ï¼Œåº”è¯¥å»é™¤æ•°æ®è¿ç§»å®¢æˆ·ç«¯çš„`truncate`æ‰©å±•

åˆ›å»º`src/libs/db/client.ts`æ–‡ä»¶ï¼Œå†™å…¥ä»¥ä¸‹ä»£ç 

:::success

æ­¤å¤„`global`ç”¨äºåœ¨å¼€å‘ç¯å¢ƒä¸‹æ—¶ï¼Œå¯ä»¥ä»å…¨å±€å˜é‡ä¸­æ‹¿åˆ°å®¢æˆ·ç«¯å®ä¾‹ï¼Œè€Œä¸è‡³äºåœ¨çƒ­é‡è½½æ—¶ä¸¢å¤±æ•°æ®åº“è¿æ¥

:::

```typescript
// src/libs/db/client.ts
/* eslint-disable no-var */
/* eslint-disable vars-on-top */
import { PrismaClient } from '@prisma/client';

const prismaClientSingleton = () => {
    return new PrismaClient();
};

declare global {
    var prismaGlobal: undefined | ReturnType<typeof prismaClientSingleton>;
}

const db = globalThis.prismaGlobal ?? prismaClientSingleton();

export default db;

if (process.env.NODE_ENV !== 'production') globalThis.prismaGlobal = db;
```

### æ•°æ®åˆ†é¡µ

prisma é»˜è®¤æ²¡æœ‰ç›´æ¥ä½¿ç”¨çš„åˆ†é¡µåŠŸèƒ½ï¼Œè€Œéœ€è¦è‡ªå·±æ‰‹åŠ¨ä½¿ç”¨ api æˆ–ç¼–å†™ sql è¿›è¡Œåˆ†é¡µã€‚ä½†æ˜¯æœ‰ä¸€ä¸ªå¥½ç”¨çš„åˆ†é¡µæ‰©å±•ï¼š[prisma-paginate][prisma-paginate]ï¼Œä¸ºäº†ç®€å•èµ·è§ï¼Œæˆ‘ä»¬å°±æ˜¯ç”¨è¿™ä¸ªæ‰©å±•æ¥ç¼–å†™åˆ†é¡µåŠŸèƒ½

å®‰è£…è¯¥æ‰©å±•

```bash
pnpm add prisma-paginate@latest
```

åœ¨å®¢æˆ·ç«¯ï¼ˆä»…åº”ç”¨å®¢æˆ·ç«¯ï¼‰ä¸­æ·»åŠ æ’ä»¶

```typescript
// src/lib/db.ts

// ...
import paginateExt from 'prisma-paginate';

const prismaClientSingleton = () => {
    return new PrismaClient().$extends(paginateExt);
};
```

ç”±äºæˆ‘ä»¬éœ€è¦è¿”å›ç»™å®¢æˆ·ç«¯çš„æ•°æ®æ ¼å¼ä¸[prisma-paginate][prisma-paginate]çš„ä¸ä¸€æ ·ã€‚ä¸ºäº†æŒ‰ç…§æˆ‘ä»¬è‡ªå·±çš„å–œå¥½è¿”å›æ•°æ®æ ¼å¼ï¼Œå†™ä¸€ä¸ªåˆ†é¡µå­—æ®µè½¬ä¹‰å‡½æ•°

æŠŠä¸Šä¸€èŠ‚è¯¾ç¨‹åœ¨`src/database/types.ts`å®šä¹‰çš„åˆ†é¡µç›¸å…³çš„ç±»å‹ç§»åŠ¨åˆ°`src/libs/db/types.ts`ä¸­ï¼Œå¹¶ä¿®æ”¹ä¸€ä¸‹`PaginateReturn`çš„`meta`å­—æ®µçš„ç±»å‹

```typescript
// src/libs/db/types.ts
// ...
/**
 * åˆ†é¡µè¿”å›æ•°æ®
 */
export interface PaginateReturn<E> {
    meta: PaginateMeta & Record<string, any>;
    items: E[];
}
```

`src/libs/db/utils.ts`ç¼–å†™è½¬ä¹‰å‡½æ•°

```typescript
// src/libs/db/utils.ts
// ...
export const paginateTransform = <M, R extends PaginationResult<M[]>>(
    data: R,
): PaginateReturn<M> => {
    const { result } = data;
    return {
        items: result,
        meta: {
            itemCount: result.length,
            totalItems: data.count,
            perPage: data.limit,
            totalPages: data.totalPages,
            currentPage: data.page,
            ...omit(data, ['result', 'count', 'limit', 'page', 'totalPages']),
        },
    };
};
```

å…·ä½“ä½¿ç”¨æˆ‘ä»¬è¯·çœ‹ ğŸ‘‡ğŸ»

### æ•°æ®æ“ä½œ

ç°åœ¨å¼€å§‹æ›¿æ¢ä¸Šä¸€èŠ‚çš„ json æ“ä½œä¸º prismaï¼Œä»£ç å¦‚ä¸‹

```typescript
// src/app/actions/post.ts
'use server';

import type { PaginateOptions, PaginateReturn } from '@/libs/db/types';
import type { Post, Prisma } from '@prisma/client';

import db from '@/libs/db/client';
import { paginateTransform } from '@/libs/db/utils';
import { getRandomInt } from '@/libs/random';
import { isNil } from 'lodash';

/**
 * æŸ¥è¯¢åˆ†é¡µæ–‡ç« åˆ—è¡¨ä¿¡æ¯
 * @param options
 */
export const queryPostPaginate = async (
    options?: PaginateOptions,
): Promise<PaginateReturn<Post>> => {
    const data = await db.post.paginate({
        orderBy: [{ updatedAt: 'desc' }, { createdAt: 'desc' }],
        page: 1,
        limit: 8,
        ...options,
    });
    return paginateTransform(data);
};

/**
 * æ ¹æ®æŸ¥è¯¢æ¡ä»¶è·å–æ–‡ç« æ€»é¡µæ•°
 * @param limit
 */
export const queryPostTotalPages = async (limit = 8): Promise<number> => {
    const data = await queryPostPaginate({ page: 1, limit });
    return data.meta.totalPages ?? 0;
};
/**
 * æ ¹æ®idæˆ–slugæŸ¥è¯¢æ–‡ç« ä¿¡æ¯
 * @param arg
 */
export const queryPostItem = async (arg: string): Promise<Post | null> => {
    const item = await db.post.findFirst({
        where: { id: arg },
    });
    return item;
};

/**
 * æ ¹æ®IDæŸ¥è¯¢æ–‡ç« ä¿¡æ¯
 * @param id
 */
export const queryPostItemById = async (id: string): Promise<Post | null> => {
    const item = await db.post.findUnique({ where: { id } });
    return item;
};

/**
 * æ–°å¢æ–‡ç« 
 * @param data
 */
export const createPostItem = async (data: Prisma.PostCreateInput): Promise<Post> => {
    const item = await db.post.create({
        data: { ...data, thumb: `/uploads/thumb/post-${getRandomInt(1, 8)}.png` },
    });
    return item;
};

/**
 * æ›´æ–°æ–‡ç« 
 * @param id
 * @param data
 */
export const updatePostItem = async (
    id: string,
    data: Partial<Omit<Post, 'id'>>,
): Promise<Post> => {
    const item = await db.post.update({ where: { id }, data });
    return item;
};

/**
 * åˆ é™¤æ–‡ç« 
 * @param id
 */
export const deletePostItem = async (id: string): Promise<Post | null> => {
    const item = await db.post.findUnique({ where: { id } });
    if (!isNil(item)) {
        await db.post.delete({ where: { id } });
        return item;
    }
    return null;
};
```

ç„¶åï¼Œè¿›è¡Œä¸€äº›æ¸…ç†å·¥ä½œ

ç§»åŠ¨å‡½æ•°ï¼šåˆ é™¤`src/database/utils.ts`å†…çš„åˆ†é¡µå‡½æ•°ï¼ŒæŠŠ`faker`å®ä¾‹è¿ç§»åˆ°`src/libs/db/utils.ts`ä¸­ï¼Œå¹¶åœ¨ä»¥ä¸‹ç”¨åˆ°`faker`å®ä¾‹çš„ seed ä¸­é‡æ–°å¯¼å…¥

```typescript
// src/libs/db/utils.ts
// ...
export const faker = new Faker({
    locale: [zh_CN, en, base],
});

// src/database/seed/post.ts
// ...
import { faker } from '@/libs/db/utils';
```

ä¿®æ”¹ç±»å‹ï¼š

- åœ¨ä½¿ç”¨åˆ°`IPost`ç±»å‹çš„åœ°æ–¹ï¼Œä¿®æ”¹å…¶ä¸º prisma å¯¼å‡ºçš„`Post`ç±»å‹
- ä¿®æ”¹`PostCreateData`ä¸º`Prisma.PostCreateInput`ç±»å‹

```typescript
// src/app/_components/post/types.ts
import { Post, Prisma } from '@prisma/client';
// ...
/**
 * æ–‡ç« æ“ä½œè¡¨å•ç»„ä»¶æ›´æ–°æ–‡ç« æ“ä½œçš„å‚æ•°
 */
export interface PostUpdateFormProps {
    type: 'update';
    // åŸæ¥çš„æ–‡ç« æ•°æ®ï¼Œç”¨äºä½œä¸ºé»˜è®¤å€¼æ•°æ®ä¸è¡¨å•ä¸­ç¼–è¾‘åçš„æ–°æ•°æ®åˆå¹¶ï¼Œç„¶åæ›´æ–°
    item: Post;
}

/**
 * æ–‡ç« æ“ä½œè¡¨å•åœ¨åˆ›å»ºæ–‡ç« æ—¶çš„submit(æäº¤è¡¨å•)å‡½æ•°çš„å‚æ•°
 */
export type PostCreateData = Prisma.PostCreateInput;

/**
 * æ–‡ç« æ“ä½œè¡¨å•åœ¨æ›´æ–°æ–‡ç« æ—¶çš„submit(æäº¤è¡¨å•)å‡½æ•°çš„å‚æ•°
 */
export type PostUpdateData = Partial<Omit<Post, 'id'>> & { id: string };

// src/app/_components/post/hooks.ts
// ...
export const usePostActionForm = (params: { type: 'create' } | { type: 'update'; item: Post }) => {
    // ...
};

export const usePostFormSubmitHandler = (
    params: { type: 'create' } | { type: 'update'; id: string },
) => {
    // ...
    let post: Post | null;
};
```

åˆ é™¤æ— ç”¨æ–‡ä»¶ï¼šåˆ é™¤`src/database`ç›®å½•ä¸‹ json å­˜å‚¨ç›¸å…³çš„ä¸å†éœ€è¦çš„æ–‡ä»¶ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤æŠŠè¿™äº›æ–‡ä»¶åˆ é™¤æ‰

```bash
rm -rf src/database/utils.ts src/database/types.ts src/database/generator.ts src/database/db.json
```

è¿˜åŸå‘½ä»¤ï¼šä¿®æ”¹`package.json`ä¸­çš„`dev`å‘½ä»¤ï¼Œè¿˜åŸä¸º`"dev": "next dev"`

ç°åœ¨ï¼Œä½¿ç”¨`pnpm dev`å¯åŠ¨åº”ç”¨ï¼Œæµ‹è¯•â€åˆ†é¡µâ€œã€â€æŸ¥è¯¢â€œã€â€åˆ›å»ºâ€œã€â€ç¼–è¾‘â€œã€â€åˆ é™¤â€œè¿™å‡ ä¸ªåŠŸèƒ½æ˜¯å¦æ­£å¸¸

### æ’åºè§„åˆ™

å¯ä»¥çœ‹åˆ°åœ¨æ·»åŠ æ–‡ç« åï¼Œæ–°çš„æ–‡ç« æ— æ³•æ˜¾ç¤ºåœ¨æœ€å‰é¢ï¼Œæ’åºæ˜¯éšæœºçš„

æ‰€ä»¥ï¼Œæˆ‘ä»¬è¦åšä¸€ä¸ªæ’åºï¼šå¦‚æœæ–‡ç« æœ‰æ›´æ–°ï¼Œé‚£ä¹ˆæŒ‰æ›´æ–°æ—¶é—´å€’åºï¼Œæ–°çš„åœ¨å‰é¢ã€‚å¦åˆ™é»˜è®¤æŒ‰åˆ›å»ºæ—¶é—´æ’åºã€‚ä¹Ÿå°±æ˜¯æ›´æ–°æ—¶é—´ç»“åˆåˆ›å»ºæ—¶é—´æ’åº

å…¶å®è¿™éå¸¸ç®€å•ï¼Œåªè¦åœ¨æŸ¥è¯¢æ—¶ï¼ŒåŠ ä¸Š`orderBy`å³å¯

:::note

åç»­è¯¾ç¨‹ï¼Œåœ¨å®Œå–„è¿™ä¸ªåº”ç”¨æ—¶ï¼Œæˆ‘ä»¬å†æ·»åŠ æ’åºé€‰æ‹©å™¨ï¼ˆæ¯”å¦‚å¯ä»¥é€‰æ‹©æŒ‰ç…§æ—¶é—´æˆ–æµè§ˆé‡æ’åºï¼‰ã€‚ç°åœ¨ï¼Œåªè¦ç®€å•åœ°æ ¹æ®æ–‡ç« æ›´æ–°ä»¥åŠåˆ›å»ºæ—¶é—´æ’åºå³å¯

:::

```typescript
// src/app/actions/post.ts
// ...
export const queryPostPaginate = async (
    options?: PaginateOptions,
): Promise<PaginateReturn<Post>> => {
    const data = await db.post.paginate({
        orderBy: [{ updatedAt: 'desc' }, { createdAt: 'desc' }],
        page: 1,
        limit: 8,
        ...options,
    });
    return paginateTransform(data);
};
```

ä¸ºæ–‡ç« åˆ—è¡¨é¡¹ç›®åŠ ä¸Šæœ€è¿‘æ›´æ–°ï¼ˆæˆ–åˆ›å»ºï¼‰æ—¶é—´

å› ä¸ºï¼Œæˆ‘ä»¬ç›®å‰æ²¡æœ‰ä½¿ç”¨åˆ°å¦‚ dayjs ç­‰ä»»ä½•æ—¶é—´åº“ï¼Œæ‰€ä»¥éœ€è¦æ·»åŠ ä¸€ä¸ªæ—¶é—´å‡½æ•°æŠŠæ•°æ®åº“ä¸­çš„æ—¶é—´å­—æ®µçš„å€¼è½¬æ¢ä¸ºä¸­æ–‡

```typescript
// src/libs/time.ts
/**
 * æ ¼å¼åŒ–æ—¶é—´è¾“å‡º
 * @param date
 */
export const formatChineseTime = (date: Date) =>
    `${date.getFullYear()}å¹´${String(date.getMonth() + 1).padStart(2, '0')}æœˆ${String(date.getDate()).padStart(2, '0')}æ—¥${String(date.getHours()).padStart(2, '0')}æ—¶${String(date.getMinutes()).padStart(2, '0')}åˆ†`;
```

ä¿®æ”¹é¦–é¡µï¼ˆæ–‡ç« åˆ—è¡¨é¡µï¼‰å’Œæ–‡ç« è¯¦æƒ…é¡µï¼ŒæŠŠåŸæ¥çš„å‡æ—¶é—´æ›¿æ¢æˆçœŸå®çš„æ–‡ç« çš„åˆ›å»º/æ›´æ–°æ—¶é—´

```tsx
// src/app/(pages)/page.tsx
// ...
<div className={$styles.meta}>
    <span>
        <AiOutlineCalendar />
    </span>
    <time className="tw-ellips">
        {!isNil(item.updatedAt)
            ? formatChineseTime(item.updatedAt)
            : formatChineseTime(item.createdAt)}
    </time>
</div>;

// src/app/(pages)/posts/[item]/page.tsx
// ...
<div className={$styles.meta}>
    <div>
        <span>
            <AiOutlineCalendar />
        </span>
        <time className="tw-ellips">
            {!isNil(post.updatedAt)
                ? formatChineseTime(post.updatedAt)
                : formatChineseTime(post.createdAt)}
        </time>
    </div>
</div>;
```

### ä¾èµ–é’©å­

ä¸ºäº†æ–¹ä¾¿ï¼Œæˆ‘ä»¬åœ¨æ¯æ¬¡è¿è¡Œ`pnpm i`å‘½ä»¤ä¹‹åï¼Œå¯ä»¥è‡ªåŠ¨æ‰§è¡Œæ•°æ®è¿ç§»å‘½ä»¤ã€‚ä¿®æ”¹`package.json`ï¼Œå¦‚ä¸‹

:::info

ä¸‰ä¸ªå‘½ä»¤åˆ†å¼€å†™ä¸ºäº†æ›´æ˜ç¡®ï¼Œå®é™…ä¸Šåªç”¨`dbms`å‘½ä»¤ä¹Ÿå¯ä»¥ï¼ˆä¸æ¨èï¼‰

:::

```json
    "scripts": {
        // ...
        "postinstall": "pnpm run dbm && pnpm run dbs && pnpm run dbg"
    },
```

æœ€åï¼Œæˆ‘ä»¬çœ‹åˆ°æœ€ç»ˆæ•ˆæœä¸ä¸Šä¸€èŠ‚è¯¾æ²¡æœ‰å·®å¼‚äº†ï¼ˆé™¤äº†å¤šäº†ä¸€ä¸ªæ–‡ç« åˆ›å»ºæˆ–æ›´æ–°æ—¶é—´æ˜¾ç¤º^v^ï¼‰

æ‰“å®Œæ”¶å·¥ï¼
