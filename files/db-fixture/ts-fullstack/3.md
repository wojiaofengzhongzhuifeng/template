[immer]: https://immerjs.github.io/immer/zh-CN/
[clsx]: https://github.com/lukeed/clsx
[lodash]: https://lodash.com/docs
[source]: https://git.3rcd.com/classroom/ts-fullstack/src/branch/main/chapter3

## å¯¼è¯»

:::note

æœ¬èŠ‚è¯¾æºç : [classroom/ts-fullstack/chapter3][source]ï¼ˆè¯·[ç™»å½•](https://git.3rcd.com/user/login?redirect_to=%2f)åæŸ¥çœ‹æˆ–å…‹éš†ï¼Œå¦åˆ™ä½ å°†æ”¶åˆ°**404 NotFound**ï¼‰

:::

å­¦ä¹ ä¸€äº›reactè‡ªå¸¦çš„hooksä»¥åŸºæœ¬æŒæ¡reactåº”ç”¨çš„ç®€å•å¼€å‘ã€‚åœ¨è¿™èŠ‚è¯¾ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡å‡ ä¸ªå°æ¡ˆä¾‹ï¼ˆå¦‚é»‘æš—ä¸»é¢˜åˆ‡æ¢ï¼Œè¯­è¨€åŒ…é€‰æ‹©ç­‰ï¼‰è¯¦ç»†æ·±å…¥åœ°äº†è§£ä¸€ä¸‹reactç¼–ç çš„ä¸€ä¸ªåŸºæœ¬è§„åˆ™ï¼Œä¸ºåé¢è¯¾ç¨‹çš„å‰ç«¯éƒ¨åˆ†çš„å­¦ä¹ æ‰“ä¸‹åšå®çš„åŸºç¡€

### è¯¾ç¨‹ç›®æ ‡

æœ¬èŠ‚è¯¾çš„ç›®æ ‡å¦‚ä¸‹

- æŒæ¡reactåŸºæœ¬ä½¿ç”¨å’Œå¼€å‘
- æŒæ¡immerçš„æ¦‚å¿µå’Œä½¿ç”¨
- æŒæ¡å¸¸ç”¨çš„React Hooksçš„ä½¿ç”¨æ–¹æ³•
- æŒæ¡è‡ªå®šä¹‰hooksçš„ç¼–å†™

### æŠ€æœ¯æ¦‚å¿µ

ä»¥ä¸‹ä¸ºæœ¬èŠ‚è¯¾æ‰€æ¶‰åŠçš„æŠ€æœ¯æ¦‚å¿µ

- [immer][immer]ï¼šä½¿ç”¨proxyå®ç°äº†ä¸å¯å˜æ•°æ®ç±»å‹
- [clsx][clsx]ï¼šä¸€ä¸ªç”¨äºåŠ¨æ€åˆæˆreact cssç±»çš„å·¥å…·
- [lodash][lodash]ï¼šåŒ…å«äº†ä¸€å¤§å †å¸¸ç”¨jså‡½æ•°çš„jså·¥å…·åº“

### å‰ç½®å‡†å¤‡

è¯·åœ¨å­¦ä¹ æœ¬è¯¾å‰åŠ¡å¿…é¢„å…ˆé˜…è¯»ä»¥ä¸‹æ–‡æ¡£

- [react apiå‚è€ƒ](https://zh-hans.react.dev/reference/react)ï¼ˆä»…ä¾›æŸ¥è¯¢æ‰€ç”¨ï¼‰
- [immer.jså®˜æ–¹æ–‡æ¡£][immer]
- @ant-design/v5-patch-for-react-19ç”¨äºè§£å†³antdå’Œreact19çš„å…¼å®¹æ€§é—®é¢˜ï¼Œè¯¦æƒ…è¯·æŸ¥çœ‹[æ­¤æ–‡ç« ](https://ant.design/docs/react/v5-for-19)

åœ¨å¼€å§‹ç¼–ç ä¹‹å‰å…ˆå®‰è£…ä»¥ä¸‹ä¾èµ–

```
pnpm add immer @ant-design/v5-patch-for-react-19
```

åœ¨`src/app/demo/layout.tsx`ä¸­å¯¼å…¥`@ant-design/v5-patch-for-react-19`

```tsx
// src/app/demo/layout.tsx
// ...
import '@ant-design/v5-patch-for-react-19';
```

æ·»åŠ ä¸€ä¸ª`src/app/demo/_components`ç›®å½•ï¼Œåœ¨demoä¸­æ·»åŠ ä¸€ä¸ª`style.module.css`ï¼Œç”¨äºè®¾ç½®æœ¬è¯¾ç¨‹æ¡ˆä¾‹çš„cssæ ·å¼

```css
/* src/app/demo/_components/style.module.css */
.container {
    @apply tw-bg-neutral-100/40 tw-shadow-black/20 tw-backdrop-blur-sm tw-shadow-md tw-rounded-md tw-p-5 tw-m-5 tw-min-w-[20rem];
}

html.dark {
    .container {
        @apply tw-bg-neutral-800/40  tw-shadow-slate-100/30;
    }
}
```

## åº”ç”¨å¼€å‘

### useState

:::warning

ä¸‹é¢æ‰€æœ‰Demoçš„æ¼”ç¤ºå›¾ä¸­çš„æ ·å¼ç­‰å¯èƒ½è·Ÿä½ è¿è¡Œæ—¶æœ‰äº›ä¸ä¸€æ ·ï¼ˆæ¯”å¦‚æ ‡é¢˜å˜ç²—å˜å¤§ç­‰ï¼‰ã€‚è¿™æ˜¯å› ä¸ºåœ¨åˆ¶ä½œè¯¾ç¨‹æ—¶ï¼Œè¿˜æ²¡æœ‰åštailwindä¸antdçš„æ ·å¼å†²çªè§£å†³ï¼Œæ‰€ä»¥ä¸å¿…æ‹…å¿ƒè¿™ä¸ªé—®é¢˜ã€‚ä½ è¿è¡Œæ—¶çš„ç•Œé¢æ‰æ˜¯æ­£å¸¸ç°è±¡ï¼

:::

æ­¤Hookç”¨äºæ”¹å˜ç»„ä»¶å†…çš„çŠ¶æ€

æ­¤é’©å­è§£æ„å‡ºä¸¤ä¸ªå€¼ï¼Œå¹¶èµ‹å€¼åˆ°ä¸€ä¸ªæ•°ç»„å†…

- ç¬¬ä¸€ä¸ªå…ƒç´ ä»£è¡¨è¯¥çŠ¶æ€çš„å€¼
- ç¬¬äºŒä¸ªå…ƒç´ ç”¨äºè®¾ç½®çŠ¶æ€çš„å€¼

ç¼–å†™å¦‚ä¸‹ç¤ºä¾‹

```tsx
// src/app/demo/_components/state.tsx
// ...
import $styles from './style.module.css';

const StateDemo: FC = () => {
    const [count, setCount] = useState(1);
    const [isShow, toggleShow] = useState(true);

    return (
        <div className={clsx($styles.container, 'tw-w-[20rem]')}>
            <h2 className="tw-text-center">useState Demo</h2>
            {isShow && <p className="tw-text-center tw-py-5">{count}</p>}
            <div className="tw-flex tw-justify-around">
                <Button onClick={() => setCount(count + 1)} type="dashed">
                    å¢åŠ 
                </Button>
                <Button onClick={() => setCount(count - 1)} type="dashed">
                    å‡å°‘
                </Button>
                <Button onClick={() => toggleShow(!isShow)} type="dashed">
                    {isShow ? 'æ˜¾ç¤º' : 'éšè—'}
                </Button>
            </div>
        </div>
    );
};
export default StateDemo;
```

ç„¶ååœ¨`src/app/demo/page.tsx`ä¸­å¼•å…¥

:::success

æ­¤å¤„æˆ‘ä»¬æ¸…ç©ºæ‰ä¸Šä¸€èŠ‚tailwindè¯¾çš„ä»£ç ï¼Œé‡ç½®ä¸ºreactåˆå§‹åŒ–è¿™èŠ‚è¯¾çš„`App.tsx`ï¼Œç„¶åå¼•å…¥`StateDemo`ç»„ä»¶

:::

```tsx
// src/app/demo/page.tsx
import type { FC } from 'react';

import StateDemo from './_components/state';

const DemoPage: FC = () => (
    <>
        <StateDemo />
    </>
);

export default DemoPage;
```

æŸ¥çœ‹ä¸€ä¸‹æ•ˆæœ

![img](https://cn-nb1.rains3.com/3rcd/202308201348797.gif)

### useEffect

åœ¨çŠ¶æ€ä¸åŒçš„ç”Ÿå‘½å‘¨æœŸæ‰§è¡Œå‰¯ä½œç”¨

è¯­æ³•ä¸º

```tsx
useEffect(() => {
  å½“ä¾èµ–é¡¹æ”¹å˜æ—¶çš„æ‰§è¡Œé€»è¾‘
  () => {
    åœ¨æ‰§è¡Œé€»è¾‘è¿è¡Œå‰æ‰§è¡Œçš„å…ˆè¡Œé€»è¾‘ï¼Œç”¨äºæ¸…ç†ç­‰æ“ä½œ
  }
},[ä¾èµ–é¡¹])
```

#### ç®€å•ç”¨æ³•

**åœ¨æ²¡æœ‰è®¾ç½®"ä¾èµ–é¡¹"æ—¶ï¼Œä»»ä½•çŠ¶æ€çš„æ”¹å˜éƒ½ä¼šå¯¼è‡´è¯¥`useEffect`æ‰§è¡Œé€»è¾‘çš„è¿è¡Œ**

æ¯æ¬¡çŠ¶æ€æ›´æ–°éƒ½ä¼šæ‰§è¡Œ`useEffect`é‡Œé¢çš„å‡½æ•°

- å½“ç‚¹å‡»**ghostæŒ‰é’®**æ—¶ï¼Œç”±äº`ghost`çš„çŠ¶æ€å˜åŒ–äº†ï¼Œæ‰€ä»¥ä¼šåŒæ—¶æ‰§è¡Œä¸¤ä¸ª`useEffect`
- åŒæ ·åœ°ï¼Œå½“**æµè§ˆå™¨å®½åº¦å‘ç”Ÿå˜åŒ–**æ—¶ï¼Œä¹Ÿä¼šåŒæ—¶æ‰§è¡Œä¸¤ä¸ª`useEffect`

```tsx
// src/app/demo/_components/effect.tsx
// ...
import { Button } from 'antd';
import { type FC, useEffect, useState } from 'react';

import $styles from './style.module.css';

const EffectDemo: FC = () => {
    const [ghost, setGhost] = useState<boolean>(false);
    const [width, setWidth] = useState(0);
    const toggleGhostBtn = () => setGhost(!ghost);
    const resizeHandle = () => setWidth(window.innerWidth);
    useEffect(() => {
        if (typeof window !== 'undefined') {
            setWidth(window.innerWidth);
            console.log('æµè§ˆå™¨å®½åº¦æ”¹å˜');
            window.addEventListener('resize', resizeHandle);
        }
    });
    useEffect(() => {
        console.log('åˆ‡æ¢å¹½çµæŒ‰é’®');
    });
    return (
        <div className={$styles.container}>
            <h2 className="tw-text-center">useEffect Demo</h2>
            <p className="tw-py-5 tw-text-center">{ghost ? 'ghost' : 'æ™®é€š'}æŒ‰é’®</p>
            <div className="tw-flex tw-flex-col tw-justify-center">
                <Button type="primary" onClick={toggleGhostBtn} ghost={ghost}>
                    åˆ‡æ¢æŒ‰é’®æ ·å¼
                </Button>
                <p className="tw-pt-5 tw-text-center">å®½åº¦ä¸º: {width}</p>
            </div>
        </div>
    );
};
export default EffectDemo;
```

ç„¶åæŠŠè¿™ä¸ªç»„ä»¶æ”¾åˆ°`App.tsx`é‡Œé¢

```tsx
// src/app/demo/page.tsx
// ...
const DemoPage: FC = () => (
    <>
        <StateDemo />
        <EffectDemo />
    </>
);
```

æ•ˆæœå¦‚ä¸‹

![](https://cn-nb1.rains3.com/3rcd/media/1735572944850.gif)

#### ä¾èµ–æ›´æ–°

é€šè¿‡`useEffect`çš„ç¬¬äºŒä¸ªå‚æ•°,å¯ä»¥æŒ‡å®šå…¶ä¾èµ–çš„å˜é‡

- åªæœ‰æ­¤å˜é‡çš„çŠ¶æ€æ›´æ”¹æ—¶æ‰ä¼šæ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°
- å¦‚æœç¬¬äºŒä¸ªå‚æ•°ä¸ºç©º,åˆ™åªåœ¨ç¬¬ä¸€æ¬¡æ¸²æŸ“å’Œé‡æ–°æ¸²æŸ“æ—¶è§¦å‘

```tsx
// src/demo/effect.tsx
// ...
const EffectDemo: FC = () => {
    // ...
    useEffect(() => {
        console.log('æµè§ˆå™¨å®½åº¦æ”¹å˜');
        window.addEventListener('resize', resizeHandle);
    }, [width]);
    useEffect(() => {
        console.log('åˆ‡æ¢å¹½çµæŒ‰é’®');
    }, [ghost]);
    useEffect(() => {
        console.log('åªåœ¨ç¬¬ä¸€æ¬¡æˆ–é‡æ–°æ¸²æŸ“ç»„ä»¶æ—¶è§¦å‘');
    }, []);
};
```

![](https://cn-nb1.rains3.com/3rcd/media/1735573522531.gif)

#### æ¸…ç†ç›‘å¬

**é€šè¿‡è¿”å›ä¸€ä¸ªå‡½æ•°å¯ä»¥åœ¨æ‰§è¡Œé€»è¾‘ä¹‹å‰è¿›è¡Œä¸€äº›æ“ä½œ**

åœ¨ç›‘å¬`width`çš„`useEffect`ä¸­,æ¯æ¬¡æ”¹å˜`width`çš„çŠ¶æ€,éƒ½ä¼šæ·»åŠ ä¸€ä¸ª`resize`äº‹ä»¶,è¿™ä¼šæå¤§çš„è€—è´¹æµè§ˆå™¨å ç”¨çš„å†…å­˜,é€šè¿‡ä¸€ä¸ªè¿”å›å€¼çš„æ–¹å¼,å³å¯åœ¨ä¸‹ä¸€æ¬¡`width`çŠ¶æ€æ”¹å˜åä¸æ·»åŠ æ–°çš„`resize`ç›‘å¬å‰,å–æ¶ˆä¸Šæ¬¡æ·»åŠ çš„`resize`ç›‘å¬äº‹ä»¶

:::success

ä¸ºäº†æ–¹ä¾¿æŸ¥çœ‹æ•ˆæœï¼Œè¿™é‡Œæˆ‘ä»¬æŠŠæ‰€æœ‰çš„`console.log`æ¸…é™¤æ‰

:::

```tsx
// src/demo/effect.tsx
// ...
const EffectDemo: FC = () => {
    // ...
    useEffect(() => {
        if (typeof window !== 'undefined') {
            setWidth(window.innerWidth);
            console.log('æµè§ˆå™¨å®½åº¦æ”¹å˜');
            window.addEventListener('resize', resizeHandle);
        }
        return () => {
            window.removeEventListener('resize', resizeHandle);
        };
    }, [width]);
};
```

#### å¼‚æ­¥æ‰§è¡Œ

åœ¨`useEffect`ä¸­æ‰§è¡Œå¼‚æ­¥å‡½æ•°çš„è¯­æ³•å¦‚ä¸‹,å…¶å®å°±æ˜¯åœ¨åŸå‡½æ•°é‡Œè°ƒç”¨ä¸€ä¸ª`async`æ‰“å¤´çš„ç«‹å³å‡½æ•°

```tsx
// src/demo/effect.tsx
// ...
useEffect(() => {
    (async () => {})();
});
```

ä»¥ä¸‹ç¤ºä¾‹ä»£ç è®©æŒ‰é’®åœ¨å˜æˆ`ghost`ä¹‹å1så†å˜çº¢è‰²

```tsx
// src/demo/effect.tsx
// ...
const EffectDemo: FC = () => {
    const [red, setRed] = useState<boolean>(false);
    // ...
    useEffect(() => {
        (async () => {
            await new Promise((resolve) => {
                setTimeout(() => resolve(true), 1000);
            });
            setRed(ghost);
        })();
    }, [ghost]);
    return (
        // ...
        <div className="tw-flex tw-justify-center tw-flex-col">
            <Button type="primary" onClick={toggleGhostBtn} ghost={ghost} danger={red}>
                åˆ‡æ¢æŒ‰é’®æ ·å¼
            </Button>
            <p className="tw-pt-5 tw-text-center">å®½åº¦ä¸º: {width}</p>
        </div>
    );
};
```

æ•ˆæœå¦‚å›¾

![](https://cn-nb1.rains3.com/3rcd/media/1735573686671.gif)

### Ref

#### useRef

è¿™ä¸ªé’©å­ç”¨äºè®°å¿†å‰ä¸€æ¬¡æ“ä½œçš„å€¼

ä»¥ä¸‹ç¤ºä¾‹ä»£è¡¨åªæœ‰åœ¨åœ¨æ•°æ®æ›´æ–°æ—¶æ‰ä¼šè°ƒç”¨å‡½æ•°ï¼Œè€Œç¬¬ä¸€æ¬¡æ¸²æŸ“ä¸ä¼šæ‰§è¡Œå‡½æ•°

```tsx
// src/app/demo/_components/ref.tsx
'use client';
// ...
import $styles from './style.module.css';

const RefDemo: FC = () => {
    const [count, setCount] = useState(0);
    const inited = useRef(count);
    useEffect(() => {
        if (inited.current !== count) {
            inited.current = count;
            console.log('changed');
        }
    }, [count]);
    return (
        <div className={clsx($styles.container, 'tw-w-80')}>
            <h2 className="tw-text-center">useRef Demo</h2>
            <p className="tw-py-5 tw-text-center">{count}</p>
            <div className="tw-flex tw-justify-around">
                <Button onClick={() => setCount(Math.ceil(Math.random() * 10))} type="dashed">
                    å˜åŒ–
                </Button>
            </div>
        </div>
    );
};

export default RefDemo;

// src/app/demo/page.tsx
// ...
<div className={$styles.app}>
    <StateDemo />
    <EffectDemo />
    <RefDemo />
</div>;
```

#### [å·²å¼ƒ]forwardRef

è¿™ä¸ªAPIåœ¨19ç‰ˆæœ¬ä¸­å¼ƒç”¨ï¼Œä½†reactä¸€èˆ¬éƒ½å‘åå…¼å®¹ï¼Œæ‰€ä»¥æˆ‘è¿™é‡Œä¹Ÿè®²è§£ä¸€ä¸‹ã€‚è¯¾ç¨‹ä¸­æ˜¯ä½¿ç”¨çš„react19äº†ï¼Œæ‰€ä»¥åœ¨è¯¾ç¨‹ä¸­ç›´æ¥æŠŠ`ref`åšä¸º`props`ä¸­ä¼ å…¥å³å¯

:::warning

ä¸ºä»€ä¹ˆè¦ç»™å‡ºreact18è¿™ä¸ªè€ç‰ˆæœ¬çš„apiå‘¢ï¼Ÿå› ä¸ºå¾ˆå¤šreactçš„ç”Ÿæ€ï¼ˆæ¯”å¦‚ç»„ä»¶åº“ç­‰ï¼‰ç›®å‰éƒ½æ˜¯ç”¨react18çš„è¯­æ³•å†™çš„ï¼Œäº†è§£è¿™ä¸ªAPIæ–¹ä¾¿æ›´å¥½çš„ä½¿ç”¨è¿™äº›ç”Ÿæ€

:::

ç»“åˆ`forwardRef`æˆ‘ä»¬å¯ä»¥æ“ä½œå­ç»„ä»¶

ä»¥ä¸‹ä»£ç ï¼Œæˆ‘ä»¬ä¸å­ç»„ä»¶å»ºç«‹ä¸€ä¸ªåŒå‘é€šè®¯çš„åŒæ—¶ï¼Œè¿˜å¯ä»¥é€šè¿‡`ref`å»æ“ä½œè¿™ä¸ªç»„ä»¶

```tsx
// src/app/demo/_components/ref.tsx
// ...
const MyInput = forwardRef<HTMLInputElement, { value: number; changeValue: (v: number) => void }>(
    ({ value, changeValue }, ref) => {
        const [local, setLocal] = useState<number | string>(value);
        useEffect(() => {
            changeValue(isNaN(Number(local)) ? 0 : Number(local));
        }, [changeValue, local]);
        const handleChange: ChangeEventHandler<HTMLInputElement> = useCallback((e) => {
            setLocal(e.target.value);
        }, []);
        return <input value={value} ref={ref} placeholder="è¯·è¾“å…¥å€¼" onChange={handleChange} />;
    },
);

const RefDemo: FC = () => {
    // ...
    const inited = useRef(count);
    const ref = useRef<HTMLInputElement | null>(null);
    useEffect(() => {
        ref.current && ref.current.focus();
    }, []);
    return (
        <div className={clsx($styles.container, 'tw-w-[20rem]')}>
            // ...
            <div className="tw-flex tw-flex-col">
                <MyInput ref={ref} value={count} changeValue={setCount} />
            </div>
        </div>
    );
};
export default RefDemo;
```

#### useImperativeHandle

è¿™ä¸ªHookç”¨äºåœ¨å­ç»„ä»¶ä¸­æ·»åŠ ä¸€äº›å‡½æ•°ï¼Œç„¶åè¿™äº›å‡½æ•°å¯ä»¥åœ¨çˆ¶ç»„ä»¶ä¸­ä¼ å…¥çš„`ref`æ¥ç»‘å®šï¼Œè¿™æ ·å°±å¯ä»¥åœ¨çˆ¶ç»„ä»¶ä¸­è°ƒç”¨è¿™äº›å­ç»„ä»¶ä¸­çš„å‡½æ•°äº†

æ­¤Hookæ¥å—ä¸‰ä¸ªå‚æ•°

- ref
- è¿”å›ç»™çˆ¶ç»„ä»¶çš„å¯¹è±¡
- æ›´æ–°ä¾èµ–å€¼

ç¼–å†™å¦‚ä¸‹ç¤ºä¾‹

```tsx
// src/app/demo/_components/ref.tsx
// ...
interface RefFunc {
    focus: () => void;
    memo: () => number;
}

const MyInput = forwardRef<RefFunc, { value: number; changeValue: (v: number) => void }>(
    ({ value, changeValue }, ref) => {
        const [local, setLocal] = useState<number | string>(value);
        const inputRef = useRef<HTMLInputElement | null>(null);
        useImperativeHandle(
            ref,
            () => ({
                focus: () => inputRef.current.focus(),
                memo: () => value,
            }),
            [value],
        );
        useEffect(() => {
            changeValue(isNaN(Number(local)) ? 0 : Number(local));
        }, [changeValue, local]);
        const handleChange: ChangeEventHandler<HTMLInputElement> = useCallback((e) => {
            setLocal(e.target.value);
        }, []);
        return (
            <input value={value} ref={inputRef} placeholder="è¯·è¾“å…¥å€¼" onChange={handleChange} />
        );
    },
);

const RefDemo: FC = () => {
    const [count, setCount] = useState(0);
    const ref = useRef<RefFunc | null>(null);
    useEffect(() => {
        ref.current && ref.current.focus();
    }, []);
    return (
        <div className={clsx($styles.container, 'tw-w-[20rem]')}>
            {/* ,,, */}
            <div className="tw-flex tw-flex-col">
                {!isNil(ref.current) && <p className="tw-my-3">å‰ä¸€ä¸ªå€¼ï¼š{ref.current.memo()}</p>}
                <MyInput ref={ref} value={count} changeValue={setCount} />
            </div>
        </div>
    );
};
export default RefDemo;
```

æ•ˆæœå¦‚ä¸‹

![](https://cn-nb1.rains3.com/3rcd/media/1735574862474.gif)

### é‡å¤æ¸²æŸ“

åœ¨ç»„ä»¶ä¸­ç›´æ¥å†™å€¼çš„æ—¶å€™ï¼Œä¼šé€ æˆæŸä¸ªç»„ä»¶æˆ–å…„å¼Ÿç»„ä»¶æˆ–åä»£ç»„ä»¶çš„é‡å¤æ¸²æŸ“ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹æ³•æ¥é¿å…è¿™ç§æƒ…å†µçš„å‘ç”Ÿä»¥æä¾›åº”ç”¨çš„æ€§èƒ½

#### useMemo

è¿™ä¸ªHookç”¨äºç¼“å­˜ä¸€äº›å€¼ï¼Œåªæœ‰å½“å®ƒçš„ä¾èµ–é¡¹æ”¹å˜æ—¶æ‰èƒ½è¿”å›æ–°çš„å€¼

è¯­æ³•å¦‚ä¸‹

:::info

å½“ä¾èµ–é¡¹æ”¹å˜æ—¶ï¼Œä¼šè‡ªè¡Œæ‰§è¡Œå‡½æ•°è¿”å›æ–°çš„å€¼

:::

```
useMemo(() => {
    è¿”å›å€¼;
}, [ä¾èµ–é¡¹]);
```

ç¼–å†™ä»¥ä¸‹ç¤ºä¾‹å¹¶åœ¨`App.tsx`ä¸­å¯¼å…¥

```tsx
// src/app/demo/_components/memo.tsx
'use client';
// ...
import $styles from './style.module.css';

const ChildCom1: FC<{ value: number }> = () => {
    console.log('æ¸²æŸ“å­ç»„ä»¶1');
    return null;
};
const ChildCom2: FC<{ value: number }> = () => {
    console.log('æ¸²æŸ“å­ç»„ä»¶2');
    return null;
};
const MemoDemo: FC = () => {
    const [count1, setCount1] = useState<number>(0);
    const [count2, setCount2] = useState<number>(0);
    return (
        <div className={clsx($styles.container, 'tw-w-[20rem]')}>
            <h2 className="tw-text-center">useMemo Demo</h2>
            <div className="tw-flex tw-justify-around">
                <Button onClick={() => setCount1(Math.ceil(Math.random() * 10))} type="dashed">
                    å˜åŒ–coun1
                </Button>
                <Button onClick={() => setCount2(Math.ceil(Math.random() * 10))} type="dashed">
                    å˜åŒ–coun2
                </Button>
            </div>
            <div className="tw-flex tw-justify-around">
                <ChildCom1 value={count1} />
                <ChildCom2 value={count2} />
            </div>
        </div>
    );
};
export default MemoDemo;

// src/app/demo/page.tsx
// ...
const DemoPage: FC = () => (
    <>
        <StateDemo />
        <EffectDemo />
        <RefDemo />
        <MemoDemo />
    </>
);
```

å¯ä»¥çœ‹åˆ°æ¯æ¬¡ï¼Œç‚¹å‡»ä¸¤ä¸ªæŒ‰é’®ä¸­çš„ä»»ä½•ä¸€ä¸ªï¼Œä¸¤ä¸ªå­ç»„ä»¶éƒ½ä¼šè¢«æ¸²æŸ“

![](https://cn-nb1.rains3.com/3rcd/media/1735576448386.gif)

è¿™æ ·å­ï¼Œå¦‚æœä¸€ä¸ªç»„ä»¶å†…æœ‰ä¸€æ‰¹å­ç»„ä»¶ï¼Œæ¯ä¸ªå­ç»„ä»¶åˆæœ‰å¾ˆå¤šå­ç»„ä»¶ï¼Œåˆ™ä¼šå‡ºç°å¤§é‡çš„é‡å¤æ¸²æŸ“è€Œå¯¼è‡´åº”ç”¨çš„æ€§èƒ½é—®é¢˜

ä¸‹é¢æˆ‘ä»¬æ¥æ”¹é€ ä¸€ä¸‹ï¼Œå˜æˆè¿™æ ·

```tsx
// src/app/demo/_components/memo.tsx
// ...
const MemoDemo: FC = () => {
    const [count1, setCount1] = useState<number>(0);
    const [count2, setCount2] = useState<number>(0);
    const ChildWrap1 = useMemo(() => <ChildCom1 value={count1} />, [count1]);
    const ChildWrap2 = useMemo(() => <ChildCom2 value={count2} />, [count2]);
    return (
        <div className={clsx($styles.container, 'tw-w-[20rem]')}>
            <h2 className="tw-text-center">useMemo Demo</h2>
            <div className="tw-flex tw-justify-around">
                <Button onClick={() => setCount1(Math.ceil(Math.random() * 10))} type="dashed">
                    å˜åŒ–coun1
                </Button>
                <Button onClick={() => setCount2(Math.ceil(Math.random() * 10))} type="dashed">
                    å˜åŒ–coun2
                </Button>
            </div>
            <div className="tw-flex tw-justify-around">
                {ChildWrap1}
                {ChildWrap2}
            </div>
        </div>
    );
};
```

æˆ‘ä»¬ä½¿ç”¨`useMemo`æŠŠç»„ä»¶åŒ…èµ·æ¥ï¼Œè¿™æ ·çš„è¯ï¼Œåªæœ‰åœ¨å®ƒçš„ä¾èµ–æ›´æ–°æ—¶æ‰ä¼šé‡æ–°æ¸²æŸ“è¿™ä¸ªå­ç»„ä»¶ï¼Œäºæ˜¯å°±å‡ºç°ä¸¤ä¸ªå­ç»„ä»¶äº’ä¸å½±å“çš„æ•ˆæœäº†

![](https://cn-nb1.rains3.com/3rcd/media/1735576566675.gif)

`useMemo`çš„ä½¿ç”¨åœºæ™¯éå¸¸å¤šï¼Œæˆ‘ä»¬å°†åœ¨åç»­è¯¾ç¨‹ä¸­ç»§ç»­æ·±å…¥

#### memoå‡½æ•°

å¦å¤–ï¼Œå¦‚æœåªæ˜¯åƒä¸Šè¿°ä¾‹å­ä¸€æ ·ï¼Œç®€å•çš„é˜²æ­¢å­ç»„ä»¶é‡å¤æ¸²æŸ“çš„è¯ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨`memo`å‡½æ•°ã€‚è¿™ä¼šæ ¹æ®ä¼ å…¥åˆ°å­ç»„ä»¶çš„props(å‚æ•°)çš„å˜åŒ–æ¥ç¡®å®šæ˜¯å¦æ¸²æŸ“è¯¥å­ç»„ä»¶ï¼Œè¾¾åˆ°çš„æ•ˆæœè·Ÿ`useMemo`æ˜¯ä¸€æ ·çš„

```tsx
// src/app/demo/_components/memo.tsx
// ...
const ChildCom1: FC<{ value: number }> = memo(() => {
    console.log('æ¸²æŸ“å­ç»„ä»¶1');
    return null;
});
const ChildCom2: FC<{ value: number }> = memo(() => {
    console.log('æ¸²æŸ“å­ç»„ä»¶2');
    return null;
});
const MemoDemo: FC = () => {
    // ...
    <div className="tw-flex tw-justify-around">
        <ChildCom1 value={count1} />
        <ChildCom2 value={count2} />
    </div>;
};
export default MemoDemo;
```

#### useCallback

è¿™ä¸ªé’©å­ä¸`useMemo`ç±»ä¼¼ï¼Œåªä¸è¿‡`useMemo`ç¼“å­˜çš„æ˜¯ä¸€ä¸ªå‡½æ•°ä¸­çš„è¿”å›å€¼ï¼Œè€Œ`useCallback`ç›´æ¥ç¼“å­˜å‡½æ•°æœ¬èº«

è¯­æ³•å¦‚ä¸‹

```tsx
useCallback(() => {}, [ä¾èµ–é¡¹]);
```

ä¾‹å¦‚ä»¥ä¸‹ä»£ç ï¼Œç”±äºåœ¨ç‚¹å‡»æŒ‰é’®æ—¶`useState`è§£æå‡ºæ¥çš„å€¼ä¼šå‘ç”Ÿå˜åŒ–ï¼Œä»è€Œå¯¼è‡´ç»„ä»¶è¢«é‡æ–°æ¸²æŸ“ï¼Œè¿™å¯¼è‡´`setCount`å’Œ`getInfo`è¿™ä¸¤ä¸ªå‡½æ•°çš„å †æ ˆåœ°å€å‘ç”Ÿå˜åŒ–

```tsx
// src/app/demo/_components/callback.tsx
'use client';
// ...
const Info: FC<{ call: () => void }> = memo(() => {
    console.log('æ¸²æŸ“æ¶ˆæ¯');
    return null;
});

export const CallbackDemo: FC = () => {
    const [, setCount] = useState<number>(0);
    const changeCount = () => setCount(Math.ceil(Math.random() * 10));
    const getInfo = () => {};
    useEffect(() => {
        console.log('getInfoå‡½æ•°çš„å€¼æ”¹å˜');
    }, [getInfo]);
    return (
        <div className={clsx($styles.container, 'tw-w-[20rem]')}>
            <h2 className="tw-text-center">useCallback Demo</h2>
            <div className="tw-flex tw-justify-around">
                <Info call={getInfo} />
                <Button onClick={changeCount} type="dashed">
                    å˜åŒ–coun1
                </Button>
            </div>
        </div>
    );
};

// src/app/demo/page.tsx
// ...
const DemoPage: FC = () => (
    <>
        <StateDemo />
        <EffectDemo />
        <RefDemo />
        <MemoDemo />
        <CallbackDemo />
    </>
);
```

æ•ˆæœ

![](https://cn-nb1.rains3.com/3rcd/media/1735577250938.gif)

ç”±äº`Info`ç»„ä»¶ä¸ä¾èµ–äº`setCount`è€Œåªä¾èµ–`getInfo`ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç”¨`useCallback`å¯¹`getInfo`åšä¸ªç¼“å­˜ï¼Œè¿™æ ·å³ä½¿`setCount`å‡½æ•°çš„å †æ ˆå‘ç”Ÿå˜åŒ–ä¹Ÿä¸å½±å“`getInfo`å‡½æ•°

```tsx
// src/app/demo/_components/callback.tsx
// ...
export const CallbackDemo: FC = () => {
    const [, setCount] = useState<number>(0);
    const changeCount = () => setCount(Math.ceil(Math.random() * 10));
    const getInfo = useCallback(() => {}, []);
    //...
};
```

![](https://cn-nb1.rains3.com/3rcd/media/1735577283171.gif)

### useContext

ç”¨äºå‘åä»£ç»„ä»¶é€ä¼ ä¸€ä¸ªå€¼ï¼ˆçŠ¶æ€ï¼‰,ä»¥åˆ›å»ºä¸€ä¸ªè¯­è¨€é€‰æ‹©å™¨ä¸ºä¾‹

#### å®šä¹‰ç±»å‹

```typescript
// src/app/demo/_components/context/types.ts
// ...
/**
 * è¯­è¨€ç±»å‹
 */
export interface LocaleType {
    /**
     * è¯­è¨€åç§°
     */
    name: string;
    /**
     * è¯­è¨€æ ‡ç­¾
     */
    label: string;
}

/**
 * è¯­è¨€çŠ¶æ€
 */
export interface LocaleState {
    locale: LocaleType;
    setLocale: (locale: LocaleType) => void;
}
```

#### å®šä¹‰è¯­è¨€åˆ—è¡¨

```typescript
// src/app/demo/_components/context/constants.ts
// ...
import type { Locale } from 'antd/es/locale';

import enUS from 'antd/es/locale/en_US';
import zhCN from 'antd/es/locale/zh_CN';

import type { LocaleType } from './types';

/**
 * antdè¯­è¨€åŒ…
 */
export const localeData: Record<string, Locale> = {
    en_US: enUS,
    zh_CN: zhCN,
};

/**
 * å¯é€‰è¯­è¨€åˆ—è¡¨
 */
export const locales: LocaleType[] = [
    {
        name: 'en_US',
        label: 'ğŸ‡ºğŸ‡¸ english(US)',
    },
    {
        name: 'zh_CN',
        label: 'ğŸ‡¨ğŸ‡³ ç®€ä½“ä¸­æ–‡',
    },
];
```

#### åˆ›å»ºcontext

```tsx
// src/app/demo/_components/context/constants.ts
// ...
'use client';
import { createContext } from 'react';

import type { LocaleState, LocaleType } from './types';

import { locales } from './constants';

export const LocaleContext = createContext<LocaleState>({
    locale: locales[0],
    setLocale: (_locale: LocaleType) => {},
});
```

#### åˆ›å»ºprovideråŒ…è£…å™¨

```tsx
// src/app/demo/_components/context/index.tsx
// ...
const LocaleProvider: FC<PropsWithChildren<LocaleState>> = ({ locale, setLocale, children }) => {
    const value = useMemo(() => ({ locale, setLocale }), [locale]);
    return <LocaleContext value={value}>{children}</LocaleContext>;
};
```

#### åˆ›å»ºLocaleç»„ä»¶

```tsx
// src/app/demo/_components/context/index.tsx
// ...
export const Locale: FC<PropsWithChildren> = ({ children }) => {
    const [locale, setLocale] = useState<LocaleType>(locales[0]);
    const changeLocale = useCallback((value: LocaleType) => {
        if (Object.keys(localeData).find((v) => v === value.name)) {
            setLocale(value);
        }
    }, []);
    return (
        <LocaleProvider locale={locale} setLocale={changeLocale}>
            {children}
        </LocaleProvider>
    );
};
```

#### åŒ…è£…Layout

ä½¿ç”¨`<Locale>`ç»„ä»¶åŒ…è£…`DemoLayout`ï¼Œè€ŒæŠŠåŸæ¥çš„åŒ…è£…æ‹†åˆ†æˆä»¥ä¸‹ä¸¤ä¸ªç»„ä»¶ï¼Œè¿™æ ·å°±å¯ä»¥ä½¿ç”¨`useContext`æ¥è·å–çŠ¶æ€äº†

```tsx
// src/app/demo/layout.tsx
// ...
const DemoAntd: FC<PropsWithChildren> = ({ children }) => (
    <ConfigProvider  {/* ... */}>
       {/* ... */}
    </ConfigProvider>
);

const DemoLayout: FC<PropsWithChildren> = ({ children }) => (
    <AntdRegistry>
        <Locale>
            <DemoAntd>{children}</DemoAntd>
        </Locale>
    </AntdRegistry>
);

export default DemoLayout;
```

ç„¶åå†æ¬¡ä¿®æ”¹`DemoAntd`ç»„ä»¶ï¼Œåœ¨`ConfigProvider`ä¸­æ‹¿åˆ°å½“å‰çš„antdè¯­è¨€åŒ…ï¼Œæ”¾å…¥å…¶é…ç½®ä¸­

```tsx
// src/app/demo/layout.tsx
// ...
const DemoAntd: FC<PropsWithChildren> = ({ children }) => {
    const { locale } = useContext(LocaleContext);
    const antdLocaleData = useMemo(() => {
        if (!Object.keys(localeData).find((v) => v === locale.name)) {
            return localeData[0];
        }
        return localeData[locale.name];
    }, [locale.name]);
    return (
        <ConfigProvider
            locale={antdLocaleData}
            {/* ... */}
        >
            {/* ... */}
        </ConfigProvider>
    );
};
```

#### è¯­è¨€é€‰æ‹©å™¨

```tsx
// src/app/demo/_components/context/index.tsx
// ...
import { Select } from 'antd';
import { Pagination, Select } from 'antd';
import $styles from '../style.module.css';

export const LocaleConfig: FC = () => {
    const { locale, setLocale } = useContext(LocaleContext);
    const changeLocale = (value: string) => {
        const current = locales.find((item) => item.name === value);
        current && setLocale(current);
    };
    return (
        <Select defaultValue={locale.name} style={{ width: 120 }} onChange={changeLocale}>
            {locales.map(({ name, label }) => (
                <Select.Option key={name} value={name}>
                    {label}
                </Select.Option>
            ))}
        </Select>
    );
};

const ContextDemo: FC = () => {
    const { locale } = useContext(LocaleContext);
    return (
        <div className={$styles.container}>
            <h2 className="tw-text-center">useContext Demo</h2>
            <p className="tw-text-center tw-py-5">å½“å‰è¯­è¨€: {locale.label}</p>
            <div className="tw-w-full">
                <h3>Antdè¯­è¨€åˆ‡æ¢æµ‹è¯•</h3>
                <div className="tw-w-full tw-my-4">
                    <LocaleConfig />
                </div>
            </div>
            <Pagination defaultCurrent={0} total={500} />
        </div>
    );
};
export default ContextDemo;
```

åœ¨é¡µé¢ä¸­åŠ å…¥Demoç»„ä»¶æŸ¥çœ‹æ•ˆæœ

```tsx
// src/app.tsx
// ...
const Wrapper: FC = () => {
    const { locale } = useContext(LocaleContext);
    const antdLocaleData = useMemo(() => {
        if (!Object.keys(localeData).find((v) => v === locale.name)) {
            return localeData[0];
        }
        return localeData[locale.name];
    }, [locale.name]);
    return (
        <ConfigProvider
            locale={antdLocaleData}
            theme={{
                algorithm: [theme.defaultAlgorithm],
                // å¯ç”¨csså˜é‡
                cssVar: true,
                hashed: false,
                token: {},
            }}
        >
            <StyleProvider hashPriority="high">
                <AntdApp>
                    <div className={$styles.app}>
                        {/* <StateDemo />
                        <EffectDemo />
                        <RefDemo />
                        <MemoDemo />
                        <CallbackDemo /> */}
                        <ContextDemo />
                    </div>
                </AntdApp>
            </StyleProvider>
        </ConfigProvider>
    );
};
const App: FC = () => (
    <Locale>
        <Wrapper />
    </Locale>
);
export default App;
```

![](https://cn-nb1.rains3.com/3rcd/media/1735582305728.gif)

### useReducer

ä½¿ç”¨`Context`+`useReducer`å¯ä»¥å®ç°è½»é‡çº§çš„å…¨å±€çŠ¶æ€ç®¡ç†ä»¥å®ç°ä¸€ä¸ªç®€å•çš„åº”ç”¨é…ç½®åŠŸèƒ½ä¸ºä¾‹(åŒ…å«æ ‡é¢˜è®¾ç½®å’Œæš—é»‘æ¨¡å¼åˆ‡æ¢)

#### ä¿®æ”¹CSS

ä¿®æ”¹ä¸€ä¸‹å…¨å±€çš„cssï¼Œè®©åº”ç”¨åœ¨æš—é»‘æ¨¡å¼ä¸‹åŠ è½½ä¸åŒçš„èƒŒæ™¯å›¾ç‰‡

ä¸‹è½½[æš—è‰²èƒŒæ™¯å›¾](https://cn-nb1.rains3.com/3rcd/media/1735580150277.png)å¹¶ä¿æŒåˆ°`src/app/styles/images`ç›®å½•ä¸­ï¼Œç„¶åé‡å‘½åä¸º"bg-dark.png"ï¼Œä¿®æ”¹demoå¸ƒå±€çš„css

```css
/* src/app/demo/layout.module.css */
.layout {
    /* ... */
}

html[class='dark'] .layout {
    @apply tw-bg-[url(../styles/images/bg-dark.png)];
}
```

#### ç¼–å†™ç±»å‹

```typescript
// src/app/demo/_components/reducer/types.ts
import type { Dispatch } from 'react';

/**
 * ä¸»é¢˜é¢œè‰²æ¨¡å¼
 */
export enum ThemeMode {
    LIGHT = 'light',
    DARK = 'dark',
}

/**
 * ä¸»é¢˜çŠ¶æ€
 */
export interface ThemeState {
    /**
     * å½“å‰ä¸»é¢˜é¢œè‰²æ¨¡å¼
     */
    mode: `${ThemeMode}`;
    /**
     * æ˜¯å¦ç´§å‡‘æ¨¡å¼
     */
    compact: boolean;
}

/**
 * ä¸»é¢˜æ“ä½œç±»å‹
 */
export enum ThemeActionType {
    /**
     * åˆ‡æ¢ä¸»é¢˜é¢œè‰²æ¨¡å¼
     */
    CHANGE_MODE = 'change_mode',
    /**
     * åˆ‡æ¢ç´§å‡‘æ¨¡å¼
     */
    CHANGE_COMPACT = 'change_compact',
}

/**
 * ä¸»é¢˜æ“ä½œ
 */
export type ThemeAction =
    | { type: `${ThemeActionType.CHANGE_MODE}`; value: `${ThemeMode}` }
    | { type: `${ThemeActionType.CHANGE_COMPACT}`; value: boolean };

/** ä¸»é¢˜çŠ¶æ€ä¸Šä¸‹æ–‡ç±»å‹ */
export interface ThemeContextType {
    state: ThemeState;
    dispatch: Dispatch<ThemeAction>;
}
```

#### é»˜è®¤é…ç½®

```typescript
// src/app/demo/_components/reducer/constants.ts
import type { ThemeState } from './types';

export const defaultThemeConfig: ThemeState = {
    mode: 'light',
    compact: false,
};
```

#### åˆ›å»ºContext

```typescript
// src/app/demo/_components/reducer/constants.ts
// é€ä¼ é…ç½®çŠ¶æ€ä¸dispatch
import { createContext } from 'react';
// ...
export const ThemeContext = createContext<ThemeContextType | null>(null);
```

#### çŠ¶æ€æ“ä½œ

ä¸ºäº†ç¡®ä¿æ•°æ®çš„å”¯ä¸€æ€§ä¸è¢«æ±¡æŸ“,ä½¿ç”¨[immer.js][immer]æ“ä½œæ•°æ®ï¼ˆå…ˆå®‰è£…ä¾èµ–åº“`pnpm add immer`ï¼Œç„¶åé‡æ–°åŠ è½½vscodeçª—å£ï¼‰

```tsx
// src/app/demo/_components/reducer/index.tsx
'use client';
// ...
import { produce } from 'immer';
import { Reducer } from 'react';

import { ThemeAction, ThemeState } from './types';

const ThemeReducer: Reducer<ThemeState, ThemeAction> = produce((draft, action) => {
    switch (action.type) {
        case 'change_mode':
            draft.mode = action.value;
            break;
        case 'change_compact':
            draft.compact = action.value;
            break;
        default:
            break;
    }
});
```

#### åŒ…è£…å™¨ç»„ä»¶

- åˆå¹¶é»˜è®¤é…ç½®å’Œåˆå§‹åŒ–é…ç½®
- æŠŠé…ç½®çŠ¶æ€å’Œ`dispatch`ä¼ ç»™`ThemeContext`

```tsx
// src/app/demo/_components/reducer/index.tsx
// ...
const defaultData: Partial<ThemeState> = {};

export const Theme: FC<PropsWithChildren<{ data?: ThemeState }>> = ({
    data = defaultData,
    children,
}) => {
    const [state, dispatch] = useReducer(ThemeReducer, data, (initData) => ({
        ...defaultThemeConfig,
        ...initData,
    }));
    useEffect(() => {
        // æ ¹æ®ä¸»é¢˜æ¨¡å¼è®¾ç½® html çš„ class
        const html = document.getElementsByTagName('html');
        if (html.length) {
            html[0].classList.remove('light');
            html[0].classList.remove('dark');
            html[0].classList.add(state.mode === 'dark' ? 'dark' : 'light');
        }
    }, [state.mode]);
    const value = useMemo(() => ({ state, dispatch }), [state]);
    return <ThemeContext value={value}>{children}</ThemeContext>;
};
```

#### ä¿®æ”¹å¸ƒå±€

åœ¨å¸ƒå±€ä¸­ä½¿ç”¨`Theme`ç»„ä»¶åŒ…è£…ï¼Œå¹¶è·å–å…¶çŠ¶æ€ä»¥ä¿®æ”¹antdçš„ä¸»é¢˜ç®—æ³•

```tsx
// src/app.tsx
// ...
const DemoAntd: FC<PropsWithChildren> = ({ children }) => {
    // ...
    const { state: themeState } = useContext(ThemeContext) || { state: defaultThemeConfig };
    const algorithm = useMemo(() => {
        const result = [themeState.compact ? theme.compactAlgorithm : theme.defaultAlgorithm];
        if (themeState.mode === 'dark') result.push(theme.darkAlgorithm);
        return result;
    }, [themeState]);
    return (
        <ConfigProvider
            locale={antdLocaleData}
            theme={{
                algorithm,
                {/* ... */}
            }}
        >
            {/* ... */}
        </ConfigProvider>
    );
};

const DemoLayout: FC<PropsWithChildren> = ({ children }) => (
    <AntdRegistry>
        <Locale>
            <Theme>
                <DemoAntd>{children}</DemoAntd>
            </Theme>
        </Locale>
    </AntdRegistry>
);
```

#### ä¸»é¢˜é€‰æ‹©å™¨

```tsx
// src/app/demo/_components/reducer/index.tsx
// ...
import { Calendar, Switch } from 'antd';
import $styles from '../style.module.css';

export const ThemeConfig: FC = () => {
    const context = useContext(ThemeContext);
    if (isNil(context)) return null;
    const { state, dispatch } = context;
    const toggleMode = () =>
        dispatch({ type: 'change_mode', value: state.mode === 'light' ? 'dark' : 'light' });
    const toggleCompact = () => dispatch({ type: 'change_compact', value: !state.compact });
    return (
        <>
            <Switch
                checkedChildren="ğŸŒ›"
                unCheckedChildren="â˜€ï¸"
                onChange={toggleMode}
                checked={state.mode === 'dark'}
                defaultChecked={state.mode === 'dark'}
            />
            <Switch
                checkedChildren="ç´§å‡‘"
                unCheckedChildren="æ­£å¸¸"
                onChange={toggleCompact}
                checked={state.compact}
                defaultChecked={state.compact}
            />
        </>
    );
};

const ReducerDemo: FC = () => {
    const context = useContext(ThemeContext);
    if (isNil(context)) return null;
    const {
        state: { mode, compact },
    } = context;
    return (
        <div className={$styles.container}>
            <h2 className="tw-text-center">useReducer Demo</h2>
            <div className="tw-flex tw-flex-col tw-items-center">
                <p>ä¸»é¢˜æ¨¡å¼: ã€Œ{mode === 'dark' ? 'æš—é»‘' : 'æ˜äº®'}ã€</p>
                <p>æ˜¯å¦ç´§å‡‘: ã€Œ{compact ? 'æ˜¯' : 'å¦'}ã€</p>
                <div className="tw-mb-5 tw-flex-auto">
                    <ThemeConfig />
                </div>
                <div className="tw-max-w-md">
                    <Calendar fullscreen={false} />
                </div>
            </div>
        </div>
    );
};

export default ReducerDemo;
```

åœ¨é¡µé¢ä¸­åŠ å…¥Demoç»„ä»¶æŸ¥çœ‹æ•ˆæœ

```tsx
// src/app/demo/page.tsx
// ...
const DemoPage: FC = () => (
    <>
        {/* <StateDemo />
        <EffectDemo />
        <RefDemo />
        <MemoDemo />
        <CallbackDemo /> */}
        <ContextDemo />
        <ReducerDemo />
    </>
);

export default DemoPage;
```

æ•ˆæœå¦‚ä¸‹

![](https://cn-nb1.rains3.com/3rcd/media/1735585117587.gif)

### è‡ªå®šä¹‰Hooks

è‡ªå®šä¹‰çš„Hookå¿…é¡»æ˜¯ä»¥`use`å¼€å¤´çš„å‡½æ•°

æˆ‘ä»¬å…ˆæŠŠ`useContext(ThemeContext)`ä»¥åŠ`useContext(LocaleContext)`æ”¹è£…æˆè‡ªå®šä¹‰Hook

```tsx
// src/app/demo/_components/hooks.tsx
'use client';
// ...
/**
 * è·å–ä¸»é¢˜çŠ¶æ€
 */
export const useTheme = () => {
    const context = useContext(ThemeContext) ?? ({} as Record<string, any>);
    return useMemo(
        () => (isNil(context.state) ? defaultThemeConfig : context.state),
        [context.state],
    );
};

/**
 * è·å–ä¸»é¢˜æ“ä½œæ–¹æ³•
 */
export const useThemeAction = () => {
    const context = useContext(ThemeContext) ?? ({} as Record<string, any>);
    return useCallback(isNil(context.dispatch) ? (_params: ThemeAction) => {} : context.dispatch, [
        context.dispatch,
    ]);
};

/**
 *
 */
export const useLocale = () => {
    const context = useContext(LocaleContext) ?? ({} as Record<string, any>);
    return useMemo(() => (isNil(context.locale) ? locales[0] : context.locale), [context.locale]);
};

/**
 *  è·å–è¯­è¨€åˆ‡æ¢æ–¹æ³•
 */
export const useLocaleAction = () => {
    const context = useContext(LocaleContext) ?? ({} as Record<string, any>);
    return useCallback(isNil(context.setLocale) ? (_locale: LocaleType) => {} : context.setLocale, [
        context.setLocale,
    ]);
};
```

ç„¶åæˆ‘ä»¬ä½¿ç”¨è¿™äº›è‡ªå®šä¹‰Hookæ”¹å˜åŸæ¥çš„ç›´æ¥`useContext`çš„æ–¹å¼

```tsx
// src/app/demo/layout.tsx
// ...
const DemoAntd: FC<PropsWithChildren> = ({ children }) => {
    const locale = useLocale();
    const antdLocaleData = useMemo(() => {
        if (!Object.keys(localeData).find((v) => v === locale.name)) {
            return localeData[0];
        }
        return localeData[locale.name];
    }, [locale.name]);
    const themeState = useTheme();
    const algorithm = useMemo(() => {
        const result = [themeState.compact ? theme.compactAlgorithm : theme.defaultAlgorithm];
        if (themeState.mode === 'dark') result.push(theme.darkAlgorithm);
        return result;
    }, [themeState]);
    // ...
};

// src/app/demo/_components/context/index.tsx
export const LocaleConfig: FC = () => {
    const locale = useLocale();
    const setLocale = useLocaleAction();
    // ...
};

const ContextDemo: FC = () => {
    const locale = useLocale();
    // ...
};
export default ContextDemo;
```

ä¸‹é¢ï¼Œæˆ‘ä»¬å†å°è¯•ç¼–å†™ä¸€ä¸ªåªåœ¨çŠ¶æ€æ›´æ–°åæ‰§è¡Œå‰¯ä½œç”¨çš„`useEffect`(ç¦ç”¨ç¬¬ä¸€æ¬¡æ¸²æŸ“å°±æ‰§è¡Œçš„æ¨¡å¼) - `useUpdateEffect`

```tsx
// src/app/demo/_components/hooks.tsx
// ...
import { isEqual, isNil } from 'lodash';
/**
 * é¦–æ¬¡æ¸²æŸ“ä¸æ‰§è¡Œï¼Œåœ¨ä¾èµ–å˜åŒ–æ—¶æ‰§è¡Œeffect
 * @param effect
 * @param deps
 */
export const useUpdateEffect = (effect: EffectCallback, deps?: DependencyList) => {
    const inited = useRef(deps);
    useEffect(() => {
        if (!isEqual(inited.current, deps)) {
            inited.current = deps;
            effect();
        }
    }, [deps]);
};

// src/app/demo/_components/custom.tsx
('use client');
// ...
import { useUpdateEffect } from './hooks';
import $styles from './style.module.css';

const CustomDemo: FC = () => {
    const [count, setCount] = useState(0);
    useUpdateEffect(() => {
        console.log('changed');
    }, [count]);
    return (
        <div className={clsx($styles.container, 'tw-w-80')}>
            <h2 className="tw-text-center">Custom Demo</h2>
            <p className="tw-py-5 tw-text-center">{count}</p>
            <div className="tw-flex tw-justify-around">
                <Button onClick={() => setCount(Math.ceil(Math.random() * 10))} type="dashed">
                    å˜åŒ–
                </Button>
            </div>
        </div>
    );
};
export default CustomDemo;

// src/app/demo/page.tsx
// ...
const DemoPage: FC = () => (
    <div className={$styles.demo}>
        <ContextDemo />
        <ReducerDemo />
        <CustomDemo />
    </div>
);
```

å¯ä»¥çœ‹åˆ°ï¼Œåœ¨é¦–æ¬¡æ¸²æŸ“æ—¶ï¼Œä¸ä¼šæ‰“å°"changed"ã€‚åªæœ‰ç‚¹å‡»æŒ‰é’®æŠŠçŠ¶æ€æ›´æ–°åæ‰ä¼šæ‰“å°

![](https://cn-nb1.rains3.com/3rcd/media/1735587323248.gif)

### æˆ‘çš„å»ºè®®

æš‚æ—¶æ¥è¯´ï¼Œä»¥ä¸Šå†…å®¹è¶³å¤Ÿåº”å¯¹å¤§éƒ¨åˆ†reactçš„åŸºç¡€å¼€å‘ã€‚ä¸è¿‡ï¼Œåœ¨next.jsçš„åº”ç”¨å¼€å‘ä¸­è‚¯å®šä¼šæ¶‰åŠåˆ°æ›´å¤šå†…å®¹ï¼Œå¤§å®¶å¯ä»¥è‡ªè¡Œåœ¨reactå®˜ç½‘æŸ¥è¯¢APIã€‚å½“ç„¶ï¼Œè¿˜æœ‰è¯¸å¦‚[react-use](https://github.com/streamich/react-use)ã€[ahooks](https://ahooks.js.org/zh-CN/)ç­‰è®¸å¤šå¥½ç”¨çš„ç¬¬ä¸‰æ–¹hooksåº“å¯ç”¨ï¼Œæˆ‘ä»¬åç»­è¯¾ç¨‹ä¼šç”¨åˆ°ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦ä¹Ÿå¯è‡ªè¡Œç ”ç©¶èµ·æ¥ï¼
