---
title: Next.jsä¸­ä½¿ç”¨Zustandè¿›è¡ŒçŠ¶æ€ç®¡ç†è¯¦è§£
sidebar_label: Next.jsä¸­ä½¿ç”¨Zustandè¿›è¡ŒçŠ¶æ€ç®¡ç†è¯¦è§£
sidebar_position: 4
---

[zustand]: https://github.com/pmndrs/zustand
[source]: https://git.3rcd.com/classroom/ts-fullstack/src/branch/main/chapter4

## å¯¼è¯»

:::note

æœ¬èŠ‚è¯¾æºç : [classroom/ts-fullstack/chapter4][source]ï¼ˆè¯·[ç™»å½•](https://git.3rcd.com/user/login?redirect_to=%2f)åæŸ¥çœ‹æˆ–å…‹éš†ï¼Œå¦åˆ™ä½ å°†æ”¶åˆ°**404 NotFound**ï¼‰

:::

å‰é¢æˆ‘ä»¬å·²ç»å­¦ä¹ äº†ä½¿ç”¨`contenxt`ã€`useReducer`ç­‰è¿›è¡ŒçŠ¶æ€ç®¡ç†ã€‚ä½†æ˜¯è¿™ç§æ–¹æ³•ç•¥æ˜¾éº»çƒ¦ï¼Œè€Œä¸”å¯¹ä»£ç æ„Ÿå®˜å’Œåº”ç”¨æ€§èƒ½å¹¶ä¸å‹å¥½ã€‚æ‰€ä»¥ï¼Œè¿™èŠ‚è¯¾ï¼Œæˆ‘ä»¬å°è¯•ä½¿ç”¨æ›´ç®€æ´å¥½ç”¨çš„[zustand][zustand]è¿›è¡ŒçŠ¶æ€ç®¡ç†ã€‚

ReactçŠ¶æ€ç®¡ç†åº“çš„ç”Ÿæ€æ¯”è¾ƒæ‚ï¼Œä¸åƒvueé‚£ä¹ˆç»Ÿä¸€ã€‚å¤§è‡´å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªæµæ´¾

- fluxç±»å‹ï¼šæœ€ä¼ ç»Ÿå’Œæ ‡å‡†çš„reactçŠ¶æ€ç®¡ç†æµæ´¾ã€‚ä»¥[redux](https://cn.redux.js.org/)ã€[redux-toolkit](https://redux-toolkit.js.org/)ã€[rematch](https://rematchjs.org/)ã€[zustand][zustand]ä¸ºä»£è¡¨
- proxyç±»å‹ï¼šç±»ä¼¼vueä¸­çš„çŠ¶æ€ç®¡ç†å·¥å…·ã€‚ä»¥[mobx](https://mobx.js.org/README.html)ã€[valtio](https://github.com/pmndrs/valtio)ä¸ºä»£è¡¨
- åŸå­çŠ¶æ€ï¼šä¸€ç§æ¯”è¾ƒæ–°çš„çŠ¶æ€ç®¡ç†æ–¹æ¡ˆã€‚ä»¥[recoil](https://recoiljs.org/)ã€[jotai](https://jotai.org/)ä¸ºä»£è¡¨

ç«™é•¿ä¸ªäººæ¯”è¾ƒå–œæ¬¢è½»é‡åˆç®€æ´çš„[zustand][zustand]ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„è¯¾ç¨‹å°±ç”¨å®ƒä½œä¸ºçŠ¶æ€ç®¡ç†å·¥å…·ã€‚**è¯·åœ¨å­¦ä¹ æœ¬èŠ‚è¯¾ä¹‹å‰åŠ¡å¿…å…ˆç²—ç•¥é˜…è¯»[zustandçš„å®˜æ–¹æ–‡æ¡£](https://docs.pmnd.rs/zustand/getting-started/introduction)**ï¼Œå¦‚æœç«¥é‹ä»¬è‡ªå·±æœ‰å…´è¶£ä¹Ÿå¯ä»¥å­¦ä¹ å¯¹æ¯”ä¸€ä¸‹å…¶ä»–çš„çŠ¶æ€ç®¡ç†åº“

### è¯¾ç¨‹ç›®æ ‡

æœ¬èŠ‚è¯¾çš„ç›®æ ‡å¦‚ä¸‹

- å­¦ä¼šzustandçš„å¸¸ç”¨æ–¹æ³•ï¼Œå¹¶åœ¨next.jsä¸­ä½¿ç”¨zustandè¿›è¡ŒçŠ¶æ€ç®¡ç†
- æŒæ¡zustandçš„ä¸€äº›å¸¸ç”¨ä¸­é—´ä»¶
- å­¦ä¼šå¦‚ä½•å°è£…zustandçŠ¶æ€åº“
- å­¦ä¹ å¦‚ä½•ä½¿ç”¨zustandå®ç°åŠ¨æ€ä¸»é¢˜åˆ‡æ¢

### æŠ€æœ¯æ¦‚å¿µ

ä»¥ä¸‹ä¸ºæœ¬èŠ‚è¯¾æ‰€æ¶‰åŠçš„æŠ€æœ¯æ¦‚å¿µ

- [reactå®˜æ–¹å…³äºçŠ¶æ€ç®¡ç†çš„è§£é‡Š](https://zh-hans.react.dev/learn/managing-state)
- [zustand](https://github.com/pmndrs/zustand)ï¼šè½»é‡çº§reactçŠ¶æ€ç®¡ç†å·¥å…·
- [utility-types](https://github.com/piotrwitek/utility-types): ä¸€ä¸ªç¬¬ä¸‰æ–¹çš„tsç±»å‹åŒ…ï¼ŒåŒ…å«äº†å¤§é‡åŸæœ¬éœ€è¦è‡ªå·±å†™çš„å¸¸ç”¨è‡ªå®šä¹‰ç±»å‹

### å‰ç½®å‡†å¤‡

å®‰è£…ä»¥ä¸‹ä¾èµ–

```bash
pnpm add zustand utility-types deepmerge
```

## ä½¿ç”¨æ–¹æ³•

zustandéå¸¸ç®€å•æ˜“ç”¨ï¼Œæˆ‘ä»¬æ¥å­¦ä¹ ä¸€ä¸‹ä»–çš„åŸºæœ¬ç”¨æ³•å’Œä¸€äº›å·¥å…·

è¿™éƒ¨åˆ†æˆ‘ä»¬å°è¯•åˆ©ç”¨çŠ¶æ€ç®¡ç†å®ç°ä¸åŒçš„Antdå¸ƒå±€é£æ ¼

æœ‰ä»¥ä¸‹å‡ ç§

- `top`: èœå•æ åœ¨é¡¶æ 
- `side`: èœå•æ åœ¨ä¾§è¾¹æ ï¼ŒLOGOä¹Ÿåœ¨ä¾§è¾¹æ 
- `content`: èœå•æ åœ¨ä¾§è¾¹æ ï¼ŒLOGOåœ¨é¡¶æ 

åŒæ—¶åŠ¨æ€åˆ‡æ¢é¢œè‰²ï¼Œä½†æ˜¯é¡¶æ å’Œä¾§è¾¹æ ä¿æŒä¸åŒé¢œè‰²ã€‚å½“é¡¶æ æˆ–è€…ä¾§è¾¹æ æ·±è‰²æ—¶ï¼Œå¦ä¸€ä¸ªæ˜¯æµ…è‰²

![](https://cn-nb1.rains3.com/3rcd/202405231729078.gif)

ç¼–å†™ä»£ç å‰ï¼Œå…ˆå®šä¹‰ä»¥ä¸‹æšä¸¾å¸¸é‡å’Œç±»å‹

```typescript
// src/demo/zustand/constants.ts
/**
 * å¸ƒå±€æ¨¡å¼
 */
export enum LayoutMode {
    /** åªæœ‰é¡¶æ å¯¼èˆª */
    TOP = 'top',
    /** ä¾§è¾¹å¯¼èˆª,é¡¶æ è‡ªå®šä¹‰ */
    SIDE = 'side',
    /** åŒside,ä½†æ˜¯LOGOåœ¨é¡¶æ  */
    CONTENT = 'content',
}
/**
 * å¸ƒå±€ç»„ä»¶
 */
export enum LayoutComponent {
    /** é¡¶æ  */
    HEADER = 'header',
    /** ä¾§è¾¹æ  */
    SIDEBAR = 'sidebar',
}

export enum LayoutActionType {
    /** æ›´æ”¹å¸ƒå±€æ¨¡å¼ */
    CHANGE_MODE = 'change_mode',
    /** æ›´æ”¹ç»„ä»¶ä¸»é¢˜ */
    CHANGE_THEME = 'change_theme',
}

// src/app/demo/_components/zustand/types.ts
/**
 * ä¸»é¢˜é¢œè‰²æ¨¡å¼
 */
export enum ThemeMode {
    LIGHT = 'light',
    DARK = 'dark',
}
/**
 * å¸ƒå±€é…ç½®
 */
export interface LayoutOptions {
    /** å¸ƒå±€æ¨¡å¼ */
    mode: `${LayoutMode}`;
    /** å¸ƒå±€ç»„ä»¶ä¸»é¢˜è‰² */
    theme: Partial<LayoutTheme>;
}

export interface LayoutActions {
    /** æ›´æ”¹å¸ƒå±€æ¨¡å¼ */
    changeMode: (value: `${LayoutMode}`) => void;
    /** æ›´æ”¹ä¸»é¢˜ */
    changeTheme: (value: Partial<LayoutTheme>) => void;
}

/**
 * å¸ƒå±€ç»„ä»¶ä¸»é¢˜è‰²
 */
export type LayoutTheme = { [key in `${LayoutComponent}`]: `${ThemeMode}` };
```

### åŸºæœ¬ç”¨æ³•

ä½¿ç”¨zustandåˆ›å»ºä¸€ä¸ªçŠ¶æ€æ± 

```typescript
// src/app/demo/_components/zustand/store.ts
'use client';
import { isNil } from 'lodash';
import { create } from 'zustand';

import { ThemeMode } from '../types';

import { LayoutActions, LayoutOptions } from './types';

/**
 * çŠ¶æ€æ± åˆ›å»ºå‡½æ•°
 */
const createLayoutStore = () =>
    create<LayoutOptions & LayoutActions>()((set) => ({
        mode: 'side',
        theme: {
            header: 'light',
            sidebar: 'dark',
        },
        changeMode: (value) => set(() => ({ mode: value })),
        changeTheme: (value) =>
            set((state) => {
                let { sidebar } = state.theme;
                // å½“åŒæ—¶ä¼ å…¥sidebarå’Œheaderæ—¶ï¼Œå»é™¤headerï¼Œä»¥sidebarä¸ºå‡†
                if (!isNil(value.sidebar)) sidebar = value.sidebar;
                // å½“åªä¼ å…¥headeræ—¶ï¼Œè®¾ç½®header
                else if (!isNil(value.header))
                    sidebar = value.header === 'light' ? 'dark' : 'light';
                // ä½¿headerå’Œsidebaræ ·å¼ç›¸å
                const header: `${ThemeMode}` = sidebar === 'light' ? 'dark' : 'light';
                return { theme: { sidebar, header } };
            }),
    }));
/**
 * åˆ›å»ºå¸ƒå±€çŠ¶æ€æ± 
 */
export const useLayoutStore = createLayoutStore();
```

ç„¶åä½¿ç”¨è¯¥çŠ¶æ€æ± åŠ¨æ€åˆ‡æ¢å¸ƒå±€å’Œé¡¶æ åŠä¾§è¾¹æ é¢œè‰²

:::info

å¸ƒå±€æ–¹æ³•å‚è€ƒ[æ­¤æ–‡æ¡£](https://ant.design/components/layout-cn)

:::

```tsx
// src/app/demo/_components/zustand/index.tsx
'use client';
import { Layout as AntdLayout, Menu as AntdMenu, Select, Switch, theme } from 'antd';
import { default as AntdSider } from 'antd/es/layout/Sider';
import {
    Content as AntdContent,
    Footer as AntdFooter,
    Header as AntdHeader,
} from 'antd/es/layout/layout';
import clsx from 'clsx';
import { FC, useCallback } from 'react';

import $styles from '../style.module.css';

import { LayoutMode } from './constants';
import { useLayoutStore } from './store';

/**
 * ç”Ÿæˆä¸€äº›èœå•æ•°æ®
 */
const items = new Array(15).fill(null).map((_, index) => ({
    key: index + 1,
    label: `nav ${index + 1}`,
}));

/**
 * èœå•ç»„ä»¶
 */
const Menu: FC = () => {
    const mode = useLayoutStore((state) => state.mode);
    const layoutTheme = useLayoutStore((state) => state.theme);
    return (
        <AntdMenu
            // å½“é¡¶æ èœå•æ—¶ï¼Œèœå•é¢œè‰²è·Ÿéšheaderï¼Œå¦åˆ™è·Ÿéšsidebar
            theme={mode === 'top' ? layoutTheme.header : layoutTheme.sidebar}
            mode={mode === 'top' ? 'horizontal' : 'inline'}
            defaultSelectedKeys={['2']}
            items={items}
            style={{ flex: 1, minWidth: 0 }}
        />
    );
};

/**
 * ä¾§è¾¹æ ç»„ä»¶
 */
const Sider: FC = () => {
    const mode = useLayoutStore((state) => state.mode);
    const layoutTheme = useLayoutStore((state) => state.theme);
    const {
        // colorBgContainer å°±æ˜¯ç™½è‰²
        token: { colorBgContainer },
    } = theme.useToken();
    return (
        <AntdSider style={{ background: layoutTheme.sidebar === 'dark' ? '' : colorBgContainer }}>
            {mode === 'side' && (
                <div className="tw-bg-slate-500 tw-w-3/4 tw-h-10 tw-mx-auto tw-my-7" />
            )}
            <Menu />
        </AntdSider>
    );
};

const Header: FC = () => {
    const layoutTheme = useLayoutStore((state) => state.theme);
    const {
        token: { colorBgContainer },
    } = theme.useToken();
    const mode = useLayoutStore((state) => state.mode);
    return (
        <AntdHeader
            style={{ background: layoutTheme.header === 'dark' ? '' : colorBgContainer }}
            className="tw-flex tw-items-center tw-px-0"
        >
            {mode !== 'side' && <div className="tw-bg-slate-500 tw-w-44 tw-h-10 tw-mx-3" />}
            {mode === 'top' && <Menu />}
        </AntdHeader>
    );
};

/**
 * å†…å®¹ç»„ä»¶
 */
const Content: FC = () => {
    const {
        token: { colorBgContainer, borderRadiusLG },
    } = theme.useToken();
    return (
        <AntdLayout className="tw-p-6">
            <AntdContent
                style={{
                    padding: 24,
                    margin: 0,
                    minHeight: 280,
                    background: colorBgContainer,
                    borderRadius: borderRadiusLG,
                }}
            >
                Content
            </AntdContent>
        </AntdLayout>
    );
};

/**
 * åº•éƒ¨ç»„ä»¶
 */
const Footer: FC = () => (
    <AntdFooter style={{ textAlign: 'center' }}>
        Ant Design Â©{new Date().getFullYear()} Created by Ant UED
    </AntdFooter>
);

/**
 * å¸ƒå±€æ¨¡å¼æ§åˆ¶ç»„ä»¶
 */
const ModeCtrol: FC = () => {
    const mode = useLayoutStore((state) => state.mode);

    const changeMode = useLayoutStore((state) => state.changeMode);
    return (
        <Select defaultValue={mode} style={{ width: 300 }} onChange={changeMode}>
            <Select.Option value={LayoutMode.SIDE}>å·¦æ èœå•ã€LOGOåœ¨è¾¹æ ã€‘</Select.Option>
            <Select.Option value={LayoutMode.CONTENT}>å·¦æ èœå•ã€LOGOåœ¨é¡¶æ ã€‘</Select.Option>
            <Select.Option value={LayoutMode.TOP}>é¡¶æ èœå•</Select.Option>
        </Select>
    );
};

/**
 * é¡¶æ å’Œä¾§è¾¹æ æ§åˆ¶ç»„ä»¶
 */
const ThemeCtrol: FC = () => {
    const layoutTheme = useLayoutStore((state) => state.theme);
    const changeTheme = useLayoutStore((state) => state.changeTheme);
    const changeSidebarTheme = useCallback(
        (value: boolean) => changeTheme({ sidebar: value ? 'dark' : 'light' }),
        [],
    );
    const changeHeaderTheme = useCallback(
        (value: boolean) => changeTheme({ header: value ? 'dark' : 'light' }),
        [],
    );
    return (
        <>
            <div>
                <span>åˆ‡æ¢ä¾§è¾¹æ ä¸»é¢˜ï¼š</span>
                <Switch
                    checkedChildren="ğŸŒ›"
                    unCheckedChildren="â˜€ï¸"
                    onChange={changeSidebarTheme}
                    checked={sidebar === 'dark'}
                    defaultChecked={sidebar === 'dark'}
                />
            </div>
            <div>
                <span>åˆ‡æ¢é¡¶æ ä¸»é¢˜ï¼š</span>
                <Switch
                    checkedChildren="ğŸŒ›"
                    unCheckedChildren="â˜€ï¸"
                    onChange={changeHeaderTheme}
                    checked={header === 'dark'}
                    defaultChecked={header === 'dark'}
                />
            </div>
        </>
    );
};

/**
 * å¸ƒå±€ç»„ä»¶
 */
export const ZustandDemo: FC = () => {
    const mode = useLayoutStore((state) => state.mode);

    return (
        <div className="tw-flex tw-flex-auto tw-justify-center tw-items-center tw-flex-col">
            <div className={clsx($styles.container, 'tw-w-[100rem] tw-flex tw-justify-between')}>
                <ModeCtrol />
                <ThemeCtrol />
            </div>
            <div className={clsx($styles.container, 'tw-w-[100rem]')}>
                <AntdLayout>
                    {mode !== 'side' && <Header />}
                    {mode === 'side' && <Sider />}
                    <AntdLayout>
                        {mode === 'side' && <Header />}
                        {mode === 'content' && <Sider />}
                        {mode !== 'content' && <Content />}
                        {mode !== 'content' && <Footer />}
                        {mode === 'content' && (
                            <AntdLayout>
                                <Content />
                                <Footer />
                            </AntdLayout>
                        )}
                    </AntdLayout>
                </AntdLayout>
            </div>
        </div>
    );
};
```

å¯¼å…¥æ ¹ç»„ä»¶å¹¶è¿è¡Œ`pnpm dev`æµ‹è¯•æ•ˆæœ

```tsx
// src/app/demo/page.tsx
// ...
const DemoPage: FC = () => (
    <div className={$styles.demo}>
        <ZustandDemo />
    </div>
);

export default DemoPage;
```

![](https://cn-nb1.rains3.com/3rcd/media/1735641381217.gif)

### immerä¸­é—´ä»¶

zustandè‡ªå¸¦immerä¸­é—´ä»¶ï¼Œç›´æ¥å¯ä»¥ä½¿ç”¨

```tsx
// src/app/demo/_components/zustand/store.ts
// ...
import { immer } from 'zustand/middleware/immer';
/**
 * çŠ¶æ€æ± åˆ›å»ºå‡½æ•°
 */
const createLayoutStore = () =>
    create<LayoutOptions & LayoutActions>()(
        immer((set) => ({
            // ...
            changeTheme: (value) =>
                set((state) => {
                    if (!isNil(value.sidebar)) {
                        state.theme.sidebar = value.sidebar;
                        state.theme.header = state.theme.sidebar === 'light' ? 'dark' : 'light';
                    } else if (!isNil(value.header)) {
                        state.theme.header = value.header;
                        state.theme.sidebar = state.theme.header === 'light' ? 'dark' : 'light';
                    }
                }),
        })),
    );
```

### é˜²æ­¢é‡å¤æ¸²æŸ“

å¦‚æœéœ€è¦ç›´æ¥ä»çŠ¶æ€ä¸­æ‹¿å¤šä¸ªå¯¹è±¡ä¼šé€ æˆé‡å¤æ¸²æŸ“ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨`useShallow`è§£å†³ã€‚ä¾‹å¦‚

```tsx
// src/app/demo/_components/zustand/index.tsx
// ...
const Sider: FC = () => {
    const {
        mode,
        theme: { sidebar },
    } = useLayoutStore(useShallow((state) => ({ mode: state.mode, theme: state.theme })));
    const {
        // colorBgContainer å°±æ˜¯ç™½è‰²
        token: { colorBgContainer },
    } = theme.useToken();
    return (
        <AntdSider style={{ background: sidebar === 'dark' ? '' : colorBgContainer }}>
            {mode === 'side' && (
                <div className="tw-bg-slate-500 tw-w-3/4 tw-h-10 tw-mx-auto tw-my-7" />
            )}
            <Menu />
        </AntdSider>
    );
};
```

### å­˜å‚¨æ•°æ®

å¯ä»¥ä½¿ç”¨`persist`ä¸­é—´ä»¶ï¼ŒæŠŠçŠ¶æ€ä¸­æŸäº›æ•°æ®å­˜å‚¨åœ¨"localstorage"é‡Œé¢ã€‚é‚£ä¹ˆåœ¨é‡æ–°æ‰“å¼€æˆ–åˆ·æ–°é¡µé¢æ—¶è¿˜ä¼šä¿æŒè®¾å®šçš„çŠ¶æ€

:::info

å…·ä½“ä½¿ç”¨æ–¹æ³•å¯ä»¥æŸ¥çœ‹[è¿™é‡Œ](https://github.com/pmndrs/zustand/blob/main/docs/integrations/persisting-store-data.md)

:::

```typescript
// src/app/demo/_components/zustand/store.ts
// ...
const createLayoutStore = () =>
    create<LayoutOptions & LayoutActions>()(
        immer(
            persist(
                (set) => ({
                    // ...
                }),
                {
                    name: 'zustand-demo',
                },
            ),
        ),
    );
```

![](https://cn-nb1.rains3.com/3rcd/media/1735640982772.gif)

### devtoolsä¸­é—´ä»¶

ä½¿ç”¨devtoolsä¸­é—´ä»¶å¯ä»¥åƒreduxä¸€æ ·è®°å½•çŠ¶æ€çš„æ“ä½œå’ŒæŸ¥çœ‹å½“å‰çŠ¶æ€ï¼ˆéœ€è¦åœ¨chromeå•†åº—ä¸­è‡ªè¡Œå®‰è£…[Redux DevTools](https://chromewebstore.google.com/detail/redux-devtools/lmhkpmbekcpmknklioeibfkpmmfibljd?pli=1)ï¼‰

:::success

é»˜è®¤æ˜¯åŒ¿åæ“ä½œï¼Œä½ ä¹Ÿå¯ä»¥ä¸ºæ¯ä¸ªæ“ä½œå‘½åã€‚å…·ä½“æŸ¥çœ‹[è¿™é‡Œ](https://github.com/pmndrs/zustand?tab=readme-ov-file#logging-actions)

:::

```typescript
// src/app/demo/_components/zustand/store.ts
// ...
const createLayoutStore = () =>
    create<LayoutOptions & LayoutActions>()(
        immer(
            devtools(
                persist(
                    (set) => ({
                        //...
                    }),
                    {
                        name: 'zustand-demo',
                    },
                ),
                { name: 'zustandDemo' },
            ),
        ),
    );
```

![](https://cn-nb1.rains3.com/3rcd/media/1735641190761.png)

### çŠ¶æ€è®¢é˜…

ä½¿ç”¨`subscribeWithSelector`ä¸­é—´ä»¶å¯ä»¥è®¢é˜…çŠ¶æ€çš„æ›´æ”¹

```typescript
// src/app/demo/_components/zustand/store.ts
// ...
const createLayoutStore = () =>
    create<LayoutOptions & LayoutActions>()(
        subscribeWithSelector(
            immer(
                devtools(
                    persist(
                       // ...
                        }),
                        {
                            name: 'zustand-demo',
                        },
                    ),
                    { name: 'zustandDemo' },
                ),
            ),
        ),
    );


const useLayoutStore = createLayoutStore();
useLayoutStore.subscribe(
    (state) => state.theme,
    (value) => {
        console.log(value);
    },
);
export { useLayoutStore };
```

![](https://cn-nb1.rains3.com/3rcd/media/1735641317781.gif)

ä¹Ÿå¯ä»¥åœ¨ç¬¬ä¸€æ¬¡æ¸²æŸ“ç»„ä»¶æ—¶å°±è§¦å‘è®¢é˜…ï¼ŒåŒæ—¶åŠ ä¸Šå¯¹è±¡æ·±åº¦å¯¹æ¯”

```typescript
// src/app/demo/_components/zustand/store.ts
// ...
import { shallow } from 'zustand/shallow';
useLayoutStore.subscribe(
    (state) => state.theme,
    (value) => {
        console.log(value);
    },
    {
        equalityFn: shallow,
        fireImmediately: true,
    },
);
```

æˆ‘ä»¬è¿˜å¯ä»¥ç”¨`subscribe`çš„è¿”å›å€¼ï¼Œåœ¨æŸä¸ªæ—¶æœºå–æ¶ˆè®¢é˜…

```typescript
const unSubLayout = useLayoutStore
    .subscribe
    // ...
    ();
unSubLayout();
```

### å…¶å®ƒç‰¹æ€§

zustandæœ‰ç€éå¸¸å¤šçš„ç©æ³•ï¼Œæ¯”å¦‚`redux`ï¼ˆä¸‹é¢éƒ¨åˆ†ç”¨åˆ°ï¼‰ç­‰ï¼Œä¸Šé¢éƒ¨åˆ†è®²è¿°äº†ä¸€äº›åŸºæœ¬çš„ç”¨æ³•ã€‚è¯¦ç»†å¯ä»¥å»çœ‹å®ƒçš„[æºç ä»“åº“](https://github.com/pmndrs/zustand)å’Œ[å®˜ç½‘æ–‡æ¡£](https://docs.pmnd.rs/zustand/getting-started/introduction)

## å…¼å®¹next.js

åœ¨next.jsä¸­ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨`Context`æŠŠçŠ¶æ€æå‡åˆ°é¡¶çº§å˜æˆå…¨å±€çŠ¶æ€ï¼Œè¿™æ˜¯å› ä¸º

- å¯¹äºzustandè¿™ç§åŸå­åŒ–çŠ¶æ€ç®¡ç†åº“æ¥è¯´ï¼Œnext.jsæ¯ä¸ªè·¯ç”±ï¼ˆé¡µé¢ï¼‰ä¸­çŠ¶æ€æ— æ³•å¾ˆå¥½çš„å…±äº«
- SSRæœºåˆ¶å¯¼è‡´å‰ç«¯é¡µé¢å’ŒæœåŠ¡å™¨ç›´å‡ºé¡µé¢åœ¨æ°´åˆåï¼Œå‰ç«¯é¡µé¢å¯¹çŠ¶æ€å¾€å¾€ä¼šå¤šæ¬¡é‡å¤æ¸²æŸ“

é¦–å…ˆï¼Œç»™`html`æ ‡ç­¾åŠ ä¸Š`suppressHydrationWarning`

```tsx
// src/app/layout.tsx
// ...
const RootLayout: FC<PropsWithChildren> = ({ children }) => (
    <html lang="en" suppressHydrationWarning>
        <body>{children}</body>
    </html>
);
```

æœ‰æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦åœ¨å¤–éƒ¨åŒ…è£…ç»„ä»¶ä¸­ä¼ å…¥ä¸€äº›è‡ªå®šä¹‰çš„çŠ¶æ€å€¼ã€‚æ‰€ä»¥ç¼–å†™ä¸€ä¸ªåŒ…è£…ç»„ä»¶

åŸºäº`deepmerge`åº“ç¼–å†™ä¸€ä¸ªè‡ªå®šä¹‰çš„å¿«é€Ÿå¯¹è±¡æ·±åº¦åˆå¹¶å‡½æ•°

```typescript
// src/libs/utils.ts
// ...
import deepmerge from 'deepmerge';

/**
 * æ·±åº¦åˆå¹¶å¯¹è±¡
 * @param x åˆå§‹å€¼
 * @param y æ–°å€¼
 * @param arrayMode å¯¹äºæ•°ç»„é‡‡å–çš„ç­–ç•¥,`replace`ä¸ºç›´æ¥æ›¿æ¢,`merge`ä¸ºåˆå¹¶æ•°ç»„
 */
export const deepMerge = <T1, T2>(
    x: Partial<T1>,
    y: Partial<T2>,
    arrayMode: 'replace' | 'merge' = 'merge',
) => {
    const options: deepmerge.Options = {};
    if (arrayMode === 'replace') {
        options.arrayMerge = (_d, s, _o) => s;
    } else if (arrayMode === 'merge') {
        options.arrayMerge = (_d, s, _o) => Array.from(new Set([..._d, ...s]));
    }
    return deepmerge(x, y, options) as T2 extends T1 ? T1 : T1 & T2;
};
```

åˆ é™¤å‰é¢çš„å¸ƒå±€åˆ›å»º

```ts
/**
 * åˆ›å»ºå¸ƒå±€çŠ¶æ€æ± 
 */
// const useLayoutStore = createLayoutStore();
// useLayoutStore.subscribe(
//     (state) => state.theme,
//     (value, _) => {
//         console.log(value);
//     },
//     {
//         equalityFn: shallow,
//         fireImmediately: true,
//     },
// );
// export { useLayoutStore };
```

æ·»åŠ ä¸€ä¸ªçŠ¶æ€ç±»å‹

```typescript
// src/app/demo/_components/zustand/types.ts
/**
 * å¸ƒå±€å…¨éƒ¨çŠ¶æ€ç±»å‹
 */
export type LayoutState = LayoutOptions & LayoutActions;
```

ä½¿ç”¨`createStore`æ›¿æ¢`create`åˆ›å»ºçŠ¶æ€ä»¥è·å¾—å­˜å‚¨å¯¹è±¡æœ¬èº«è€Œä¸æ˜¯ä¸€ä¸ªhooksï¼Œç„¶åä¼ å…¥è‡ªå®šä¹‰å‚æ•°å¹¶æ·±åº¦åˆå¹¶è‡ªå®šä¹‰å‚æ•°

```typescript
// src/app/demo/_components/zustand/store.ts
//...
export const createLayoutStore = (options: DeepPartial<LayoutOptions> = {}) =>
    createStore<LayoutState>()(
        subscribeWithSelector(
            immer(
                devtools(
                    persist(
                        (set) => ({
                            ...deepMerge<LayoutOptions, DeepPartial<LayoutOptions>>(
                                {
                                    mode: 'side',
                                    theme: {
                                        header: 'light',
                                        sidebar: 'dark',
                                    },
                                },
                                options,
                                'replace',
                            ),
                            changeMode: (value) => set(() => ({ mode: value })),
                            changeTheme: (value) =>
                                set((state) => {
                                    if (!isNil(value.sidebar)) {
                                        state.theme.sidebar = value.sidebar;
                                        state.theme.header =
                                            state.theme.sidebar === 'light' ? 'dark' : 'light';
                                    } else if (!isNil(value.header)) {
                                        state.theme.header = value.header;
                                        state.theme.sidebar =
                                            state.theme.header === 'light' ? 'dark' : 'light';
                                    }
                                }),
                        }),
                        {
                            name: 'zustand-demo',
                        },
                    ),
                    { name: 'zustandDemo' },
                ),
            ),
        ),
    );
```

æ·»åŠ ä¸€ä¸ªçŠ¶æ€æ± ç±»å‹

```typescript
// src/app/demo/_components/zustand/types.ts
/**
 * å¸ƒå±€çŠ¶æ€æ± ç±»å‹
 */
export type LayoutStoreType = ReturnType<typeof createLayoutStore>;
```

æ·»åŠ ä¸€ä¸ª`Context`

```typescript
// src/app/demo/_components/zustand/constants.ts
// ...
/**
 * çŠ¶æ€ä¸Šä¸‹æ–‡åŒ…è£…å™¨
 */
export const LayoutContext = createContext<LayoutStoreType | null>(null);
```

åˆ›å»ºä¸€ä¸ª`Context`åŒ…è£…ç»„ä»¶ï¼Œå¹¶æŠŠå®ƒåŒ…è£…åœ¨æ ¹ç»„ä»¶ä¸­

```tsx
// src/app/demo/_components/zustand/index.tsx
// ...
/**
 * çŠ¶æ€æ± åŒ…è£…å™¨
 * @param param0
 */
export const LayoutStore: FC<PropsWithChildren<DeepPartial<LayoutOptions>>> = ({
    children,
    ...props
}) => {
    const storeRef = useRef<LayoutStoreType>(null);
    if (isNil(storeRef.current)) {
        storeRef.current = createLayoutStore(props);
    }
    return <LayoutContext value={storeRef.current}>{children}</LayoutContext>;
};

// src/app/demo/layout.tsx
const DemoLayout: FC<PropsWithChildren> = ({ children }) => (
    <LayoutStore>
        <AntdRegistry>
            <Locale>
                <Theme>
                    <DemoAntd>{children}</DemoAntd>
                </Theme>
            </Locale>
        </AntdRegistry>
    </LayoutStore>
);
export default DemoLayout;
```

æ·»åŠ ä¸€ä¸ªç”¨äºé€šè¿‡`Context`è·å–çŠ¶æ€çš„hooks

```typescript
// src/app/demo/_components/zustand/hooks.ts
// ...
/**
 * çŠ¶æ€é€‰æ‹©å™¨
 * @param selector
 */
export function useLayoutContext<T>(selector: (state: LayoutState) => T): T {
    const store = useContext(LayoutContext);
    if (!store) throw new Error('Missing LayoutContext.Provider in the tree');
    return useStore(store, useShallow(selector));
}
```

ç°åœ¨éœ€è¦ä¿®æ”¹æ‰€æœ‰ç»„ä»¶ä¸­çš„çŠ¶æ€è·å–æ–¹å¼ï¼Œä¾‹å¦‚

```tsx
// src/app/demo/_components/zustand/index.tsx
// ...
const Header: FC = () => {
    const mode = useLayoutContext((s) => s.mode);
    const { header } = useLayoutContext((s) => ({ ...s.theme }));
    const {
        token: { colorBgContainer },
    } = theme.useToken();
    return (
        <AntdHeader
            style={{ background: header === 'dark' ? '' : colorBgContainer }}
            className="tw-flex tw-items-center tw-px-0"
        >
            {mode !== 'side' && <div className="tw-mx-3 tw-h-10 tw-w-44 tw-bg-slate-500" />}
            {mode === 'top' && <Menu />}
        </AntdHeader>
    );
};
```

è¿™æ ·å°±å¯ä»¥åœ¨ä»»ä½•é¡µé¢ä¸­ä½¿ç”¨å¸ƒå±€è®¾ç½®çš„çŠ¶æ€äº†

## å°è£…Zustand

ä¸ºäº†æ›´æ–¹ä¾¿å¿«æ·åœ°ä½¿ç”¨zustandåˆ›å»ºçŠ¶æ€ï¼Œæˆ‘ä»¬å¯¹å…¶è¿›è¡Œä¸€å®šçš„å°è£…ã€‚

æ‰€æœ‰åˆ›å»ºå‡½æ•°éƒ½åŒ…å«äº†`immer`ã€`subscribeWithSelector`ã€`devtools`è¿™å‡ ä¸ªä¸­é—´ä»¶ã€‚`createReduxStore`å’Œ`createPersistReduxStore`ç”¨äºåˆ›å»º"redux"çŠ¶æ€æ± ã€‚`createPersistStore`å’Œ`createPersistReduxStore`åŒ…å«äº†`persist`ä¸­é—´ä»¶ã€‚

```typescript
// src/libs/store.ts
// ...
import type { StateCreator } from 'zustand';
import type { DevtoolsOptions, PersistOptions } from 'zustand/middleware';

import { createStore as createStoreFunction } from 'zustand';
import { devtools, persist, redux, subscribeWithSelector } from 'zustand/middleware';
import { immer } from 'zustand/middleware/immer';

/**
 * åˆ›å»ºåŒ…å«è®¢é˜…ï¼Œimmerä»¥åŠdevtooolsåŠŸèƒ½çš„æ™®é€šçŠ¶æ€å•†åº—
 * @param creator
 * @param devtoolsOptions
 */
export const createStore = <T extends object>(
    creator: StateCreator<
        T,
        [
            ['zustand/subscribeWithSelector', never],
            ['zustand/immer', never],
            ['zustand/devtools', never],
        ]
    >,
    devtoolsOptions?: DevtoolsOptions,
) => {
    return createStoreFunction<T>()(
        subscribeWithSelector(immer(devtools(creator, devtoolsOptions))),
    );
};

/**
 * åˆ›å»ºåŒ…å«è®¢é˜…ï¼Œimmerä»¥åŠdevtooolsåŠŸèƒ½çš„æ™®é€šçŠ¶æ€å•†åº—
 * åŒæ—¶æ”¯æŒè‡ªåŠ¨å­˜å‚¨åˆ°å®¢æˆ·ç«¯ï¼Œé»˜è®¤å­˜å‚¨åˆ°localstorage
 * @param creator
 * @param persistOptions
 * @param devtoolsOptions
 */
export const createPersistStore = <T extends object, P = T>(
    creator: StateCreator<
        T,
        [
            ['zustand/subscribeWithSelector', never],
            ['zustand/immer', never],
            ['zustand/devtools', never],
            ['zustand/persist', P],
        ]
    >,
    persistOptions: PersistOptions<T, P>,
    devtoolsOptions?: DevtoolsOptions,
) => {
    return createStoreFunction<T>()(
        subscribeWithSelector(
            immer(devtools(persist(creator as unknown as any, persistOptions), devtoolsOptions)),
        ),
    );
};

/**
 * åˆ›å»ºåŒ…å«è®¢é˜…ï¼Œimmerä»¥åŠdevtooolsåŠŸèƒ½çš„reducerçŠ¶æ€å•†åº—
 * åŒæ—¶æ”¯æŒè‡ªåŠ¨å­˜å‚¨åˆ°å®¢æˆ·ç«¯ï¼Œé»˜è®¤å­˜å‚¨åˆ°localstorage
 * @param reducer
 * @param initialState
 * @param devtoolsOptions
 */
export const createReduxStore = <
    T extends object,
    A extends {
        type: string;
    },
>(
    reducer: (state: T, action: A) => T,
    initialState: T,
    devtoolsOptions?: DevtoolsOptions,
) =>
    createStoreFunction(
        subscribeWithSelector(immer(devtools(redux(reducer, initialState), devtoolsOptions))),
    );

/**
 * åˆ›å»ºåŒ…å«è®¢é˜…ï¼Œimmerä»¥åŠdevtooolsåŠŸèƒ½çš„reducerçŠ¶æ€å•†åº—
 * @param reducer
 * @param initialState
 * @param persistOptions
 * @param devtoolsOptions
 */
export const createPersistReduxStore = <
    T extends object,
    A extends {
        type: string;
    },
    P = T,
>(
    reducer: (state: T, action: A) => T,
    initialState: T,
    persistOptions: PersistOptions<T, P>,
    devtoolsOptions?: DevtoolsOptions,
) =>
    createStoreFunction(
        subscribeWithSelector(
            immer(
                devtools(
                    persist(redux(reducer, initialState), persistOptions as any),
                    devtoolsOptions,
                ),
            ),
        ),
    );
```

å¦å¤–ï¼Œä½¿ç”¨[auto-zustand-selectors-hook](https://github.com/Albert-Gao/auto-zustand-selectors-hook)ï¼Œè®©æˆ‘ä»¬å¯ä»¥åƒhooksä¸€æ ·å»è¯»å–çŠ¶æ€ï¼Œæœ‰å…´è¶£å¯å‚è€ƒå…¶[ä»“åº“](https://github.com/Albert-Gao/auto-zustand-selectors-hook)ã€‚

## å®æˆ˜-åŠ¨æ€ä¸»é¢˜

ä¸‹é¢æˆ‘ä»¬æ”¹é€ å‰é¢çš„åŠ¨æ€ä¸»é¢˜åˆ‡æ¢æ–¹æ¡ˆï¼Œä½¿ç”¨[zustand][zustand]å»å®ç°ã€‚ä½†ä¸å‰é¢è¯¾ç¨‹ä¸åŒçš„æ˜¯ï¼Œæœ¬æ¬¡æˆ‘ä»¬æ·»åŠ äº†

- æ ¹æ®ç³»ç»Ÿé»˜è®¤ä¸»é¢˜åˆ‡æ¢æ˜æš—çš„æ–°æ¨¡å¼
- å‡ºäº†antdå¤–ï¼Œä¸ºshadcnä¹Ÿæ·»åŠ ä¸€ä¸ªæ˜æš—ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½

åˆ›å»ºä»¥ä¸‹æ–‡ä»¶ç»“æ„

```shell
src/components/theme
â”œâ”€â”€ constants.ts  # å¸¸é‡
â”œâ”€â”€ hooks.ts # hooks
â”œâ”€â”€ index.tsx # åŒ…è£…ç»„ä»¶
â”œâ”€â”€ store.ts # çŠ¶æ€æ± 
â””â”€â”€ types.ts # ç±»å‹
```

æˆ‘ä»¬ä½¿ç”¨[zustand][zustand]+`redux`ä¸­é—´ä»¶+`Context`å®ç°è¯¥ç»„ä»¶

### å¸¸é‡åŠç±»å‹

é™¤äº†å¢åŠ ç³»ç»Ÿä¸»é¢˜æ¨¡å¼å¤–ï¼Œå…¶å®ƒåŸºæœ¬éƒ½æ˜¯ä»`src/demo/reducer.tsx`å¤åˆ¶è¿‡æ¥æ”¹çš„

```typescript
// src/app/_components/theme/constants.ts
/**
 * ä¸»é¢˜æ¨¡å¼
 */
export enum ThemeMode {
    LIGHT = 'light',
    DARK = 'dark',
    SYSTEM = 'system',
}

/**
 * ä¸»é¢˜æ“ä½œç±»å‹
 */
export enum ThemeActions {
    // åˆ‡æ¢ä¸»é¢˜é»‘äº®
    CHANGE_MODE = 'change_mode',
    // åè½¬ä¸»é¢˜é»‘äº®
    TOOGLE_MODE = 'toggle_mode',
    // åˆ‡æ¢ç´§å‡‘ä¸»é¢˜
    CHANGE_COMPACT = 'change_compact',
    // åè½¬ç´§å‡‘ä¸»é¢˜
    TOOGLE_COMPACT = 'toggle_compact',
}

/**
 * é»˜è®¤é…ç½®
 */
export const defaultThemeOptions: ThemeOptions = {
    mode: 'system',
    compact: false,
};

// src/app/_components/theme/types.ts
/**
 * çŠ¶æ€ç±»å‹
 */
export interface ThemeOptions {
    mode: `${ThemeMode}`;
    compact: boolean;
}

/**
 * Redux dispatch
 */
export type ThemeDispatchs =
    | { type: `${ThemeActions.CHANGE_MODE}`; value: `${ThemeMode}` }
    | { type: `${ThemeActions.TOOGLE_MODE}` }
    | { type: `${ThemeActions.CHANGE_COMPACT}`; value: boolean }
    | { type: `${ThemeActions.TOOGLE_COMPACT}` };

/**
 * çŠ¶æ€å‚æ•°
 */
export type ThemeState = ThemeOptions & {
    dispatch: (action: ThemeDispatchs) => ThemeDispatchs;
};
```

### çŠ¶æ€æ± 

åˆ›å»ºçš„çŠ¶çŠ¶æ€æ± å¹¶é€šè¿‡`theme`é”®å­˜å‚¨åˆ°localstorageä¸­

```tsx
// src/app/_components/theme/store.ts
// ...
/**
 * åˆ›å»ºreducer
 */
const ThemeReducer: Reducer<ThemeOptions, ThemeDispatchs> = produce((draft, action) => {
    switch (action.type) {
        case 'change_mode':
            draft.mode = action.value;
            break;
        case 'toggle_mode':
            if (draft.mode === 'system') {
                draft.mode = getSystemTheme() === 'dark' ? 'light' : 'dark';
            } else {
                draft.mode = draft.mode === 'dark' ? 'light' : 'dark';
            }
            break;
        case 'change_compact':
            draft.compact = action.value;
            break;
        case 'toggle_compact':
            draft.compact = !draft.compact;
            break;
        default:
            break;
    }
});

/**
 * çŠ¶æ€æ± åˆ›å»ºå‡½æ•°
 */
export const createThemeStore = (options: Partial<ThemeOptions> = {}) =>
    createPersistReduxStore(
        ThemeReducer,
        { ...defaultThemeOptions, ...options },
        {
            name: 'theme',
            partialize: (state) => ({ mode: state.mode, compact: state.compact }),
        },
    );

// src/app/_components/theme/types.ts
/**
 * çŠ¶æ€æ± ç±»å‹
 */
export type ThemeStoreType = ReturnType<typeof createThemeStore>;
```

### çŠ¶æ€å…±äº«

`Context`å’Œ`Provider`çš„åˆ›å»ºä¸ä¸Šé¢çš„demoç±»ä¼¼

```typescript
// src/app/_components/theme/constants.ts
// ...
/**
 * åˆ›å»ºç”¨äºå…¨å±€å…±äº«çš„çŠ¶æ€Context
 */
export const ThemeContext = createContext<ThemeStoreType | null>(null);


// src/app/_components/theme/index.tsx
'use client';
// ...
const Theme: FC<PropsWithChildren<Partial<ThemeOptions>>> = ({ children, ...props }) => {
    const storeRef = useRef<ThemeStoreType>();
    if (!storeRef.current) {
        storeRef.current = createThemeStore(props);
    }
    return <ThemeContext.Provider value={storeRef.current}>{children}</ThemeContext.Provider>;
};
export default Theme;
```

æ·»åŠ ä¸€ä¸ªç”¨äºè·å–çŠ¶æ€çš„hooks

```typescript
// src/app/_components/theme/hooks.ts
'use client';
// ...
/**
 * è·å–æ•´ä¸ªçŠ¶æ€æ± å¯¹è±¡
 */
export function useThemeStore() {
    const store = useContext(ThemeContext);
    if (!store) throw new Error('Missing Theme Component in the tree');
    return store;
}

/**
 * è·å–ä¸»é¢˜çŠ¶æ€
 * @param selector
 */
export function useThemeState<T>(selector: (state: ThemeState) => T): T {
    const store = useThemeStore();
    return useStore(store, useShallow(selector));
}
```

ç¼–å†™ä¸€ä¸ªç”¨äºè·å–æ“ä½œç³»ç»Ÿä¸»é¢˜çš„é’©å­ï¼Œåœ¨ç¬¬ä¸€æ¬¡æ‰“å¼€é¡µé¢æ—¶ï¼Œç”¨æˆ·æ²¡æœ‰æ‰‹åŠ¨è®¾ç½®ä¸»é¢˜çŠ¶æ€å¹¶å­˜å‚¨äº`localstorage`ï¼Œã€è¿™æ—¶å€™é»˜è®¤ä½¿ç”¨ç³»ç»Ÿä¸»é¢˜

```ts
// src/app/_components/theme/hooks.ts
/**
 * è·å–ç³»ç»Ÿå½“å‰ä¸»é¢˜
 */
export const getSystemTheme = () => {
    if (typeof window === 'undefined') return 'light';
    const isDarkTheme = window.matchMedia('(prefers-color-scheme: dark)').matches;
    return isDarkTheme ? 'dark' : 'light';
};

// src/app/_components/theme/hooks.ts
// ...
/**
 * è·å–ç³»ç»Ÿä¸»é¢˜é¢œè‰²
 */
export const useSystemTheme = (): 'dark' | 'light' => {
    const [isDarkTheme, setIsDarkTheme] = useState(getSystemTheme());
    useEffect(() => {
        const setSystemDark = () => setIsDarkTheme(getSystemTheme());
        window.addEventListener('change', setSystemDark);
        return () => {
            window.removeEventListener('change', setSystemDark);
        };
    }, []);

    return isDarkTheme ? 'dark' : 'light';
};

/**
 * è·å–ä¸»é¢˜æœ€ç»ˆé¢œè‰²
 */
export const useThemeColor = () => {
    const { mode } = useTheme();
    const systemTheme = useSystemTheme();
    return mode === 'system' ? systemTheme : mode;
};
```

ä¸ºäº†åˆ‡æ¢ä¸»é¢˜æ—¶ï¼Œæ›´æ”¹tailwindæ‰€éœ€çš„`html`çš„`class`ï¼Œæˆ‘ä»¬éœ€è¦åˆ¶ä½œä¸€ä¸ªå­ç»„ä»¶ã€‚è¯¥ç»„ä»¶è®¢é˜…æš—é»‘æ¨¡å¼ï¼Œåœ¨æ¨¡å¼æ”¹å˜æ—¶ï¼Œåˆ‡æ¢`html`çš„`class`ã€‚åœ¨`mode`æ˜¯`system`ï¼Œä¹Ÿå°±æ˜¯ç³»ç»Ÿé»˜è®¤ä¸»é¢˜æ—¶ï¼Œåˆ™æ ¹æ®ç³»ç»Ÿä¸»é¢˜æ˜¯å¦ä¸º`dark`æ¥ç¡®è®¤`html`åº”è¯¥æ·»åŠ çš„ç±»

```typescript
// src/app/_components/theme/index.tsx
// ...
const ThemeSubscriber: FC<PropsWithChildren> = ({ children }) => {
    const systemTheme = useSystemTheme();
    const store = useThemeStore();
    let unSub: () => void;
    useEffect(() => {
        unSub = store.subscribe(
            (state) => state.mode,
            (m) => {
                const html = document.getElementsByTagName('html');
                if (html.length) {
                    html[0].classList.remove('light');
                    html[0].classList.remove('dark');
                    if (m === 'system') html[0].classList.add(systemTheme);
                    else html[0].classList.add(m === 'dark' ? 'dark' : 'light');
                }
            },
            {
                fireImmediately: true,
            },
        );
        return () => {
            if (!isNil(unSub)) unSub();
        };
    }, [systemTheme]);
    return <>{children}</>;
};


const Theme: FC<PropsWithChildren<Partial<ThemeOptions>>> = ({ children, ...props }) => {
    // ...
    return (
        <ThemeContext.Provider value={storeRef.current}>
            <ThemeSubscriber>{children}</ThemeSubscriber>
        </ThemeContext.Provider>
    );
}

export default Theme;
```

### çŠ¶æ€è·å–

æ·»åŠ å‡ ä¸ªå¿«æ·é’©å­ï¼Œä¾¿äºç›´æ¥è·å–çŠ¶æ€å’Œä½¿ç”¨æ“ä½œæ–¹æ³•å…¶ä¸­ï¼Œç³»ç»Ÿä¸»é¢˜é€šè¿‡`window.matchMedia('(prefers-color-scheme: dark)').matches`è·å– :::note `useThemeColor`å†™ä¸å†™æ— æ‰€è°“ï¼Œå› ä¸ºæœ¬èŠ‚è¯¾ç”¨ä¸åˆ° :::

```typescript
// src/app/_components/theme/utils.ts
/**
 * è·å–ç³»ç»Ÿå½“å‰ä¸»é¢˜
 */
export const getSystemTheme = () => {
    if (typeof window === 'undefined') return 'light';
    const isDarkTheme = window.matchMedia('(prefers-color-scheme: dark)').matches;
    return isDarkTheme ? 'dark' : 'light';
};

// src/app/_components/theme/hooks.ts
// ...
/**
 * è·å–ä¸»é¢˜æ¨¡å¼çŠ¶æ€
 */
export const useTheme = () =>
    useThemeState((state) => ({ mode: state.mode, compact: state.compact }));

/**
 * è·å–ä¸»é¢˜æ“ä½œå‡½æ•°
 */
export const useThemeActions = () => {
    const dispatch = useThemeState((state) => state.dispatch);
    return {
        changeMode: useCallback(
            // é˜²æŠ–é™åˆ¶ï¼Œé˜²æ­¢å¿«é€Ÿæ“ä½œ
            debounce((v: `${ThemeMode}`) => dispatch({ type: 'change_mode', value: v }), 100, {}),
            [],
        ),
        toggleMode: useCallback(
            debounce(() => dispatch({ type: 'toggle_mode' }), 100, {}),
            [],
        ),
        changeCompact: useCallback(
            (v: boolean) => dispatch({ type: 'change_compact', value: v }),
            [],
        ),
        toggleCompact: useCallback(() => dispatch({ type: 'toggle_compact' }), []),
    };
};

/**
 * è·å–ç³»ç»Ÿä¸»é¢˜é¢œè‰²
 */
export const useSystemTheme = (): 'dark' | 'light' => {
    const [isDarkTheme, setIsDarkTheme] = useState(getSystemTheme());
    useEffect(() => {
        const setSystemDark = () => setIsDarkTheme(getSystemTheme());
        window.addEventListener('change', setSystemDark);
        return () => {
            window.removeEventListener('change', setSystemDark);
        };
    }, []);

    return isDarkTheme ? 'dark' : 'light';
};

/**
 * è·å–ä¸»é¢˜æœ€ç»ˆé¢œè‰²
 */
export const useThemeColor = () => {
    const { mode } = useTheme();
    const systemTheme = useSystemTheme();
    return mode === 'system' ? systemTheme : mode;
};
```

### åˆ‡æ¢Antd

ç¼–å†™ä¸€ä¸ªè®¾ç½®ç»„ä»¶ï¼Œç”¨äºåˆ‡æ¢Antdçš„æ˜æš—å’Œç´§å‡‘çš®è‚¤

å…ˆå†™ä¸€ä¸ªé’©å­ï¼Œé€šè¿‡ä¸»é¢˜çŠ¶æ€è·å–Antdé»‘æš—å’Œç´§å‡‘çš®è‚¤çš„ç®—æ³•

```ts
// src/app/_components/theme/hooks.ts
// ...
/**
 * è·å– Antd ä¸»é¢˜é…ç½®ç®—æ³•
 */
export const useAntdAlgorithm = () => {
    const { mode, compact } = useTheme();
    const systemTheme = useSystemTheme();
    return useMemo(() => {
        const result = [compact ? theme.compactAlgorithm : theme.defaultAlgorithm];
        if (mode === 'dark' || (mode === 'system' && systemTheme === 'dark'))
            result.push(theme.darkAlgorithm);
        return result;
    }, [systemTheme, mode, compact]);
};
```

ç¼–å†™é€‰æ‹©å™¨ç»„ä»¶ä»£ç å¦‚ä¸‹

:::note

æš‚æ—¶æˆ‘ä»¬æ²¡æœ‰æ·»åŠ ç³»ç»Ÿä¸»é¢˜é€‰æ‹©å™¨é€‰é¡¹ï¼ˆç­‰ä¼šå„¿æˆ‘ä»¬åœ¨å‰å°shadcnçš®è‚¤ä¸­æ·»åŠ ï¼‰ï¼ŒAntdé€‰æ‹©å™¨æˆ‘ä»¬åªåšæ˜äº®å’Œé»‘æš—é€‰æ‹©å³å¯ã€‚æ‰€ä»¥ï¼Œç­‰ä¸€ä¸‹æµ‹è¯•çš„æ—¶å€™ï¼Œæˆ‘ä»¬æŠŠ`localstorage`é‡Œé¢çš„ä¸»é¢˜çŠ¶æ€åˆ é™¤

:::

```tsx
// src/app/_components/theme/setting.tsx
// ...
/**
 * Antdä¸»é¢˜é€‰æ‹©å™¨
 */
export const AntdThemeSetting: FC = () => {
    const { mode, compact } = useTheme();
    const { toggleMode, toggleCompact } = useThemeActions();
    return (
        <>
            <Switch
                checkedChildren="ğŸŒ›"
                unCheckedChildren="â˜€ï¸"
                onChange={toggleMode}
                checked={mode === 'dark'}
                defaultChecked={mode === 'dark'}
            />
            <Switch
                checkedChildren="ç´§å‡‘"
                unCheckedChildren="æ­£å¸¸"
                onChange={toggleCompact}
                checked={compact}
                defaultChecked={compact}
            />
        </>
    );
};
```

ç”¨æ–°çš„`Theme`ç»„ä»¶æ›¿æ¢æ¢æ¥demoä¸­åˆ°å¤„çš„`Theme`åŒ…è£…å¸ƒå±€ç»„ä»¶ï¼Œå¹¶é€šè¿‡`useAntdAlgorithm`ç”Ÿæˆä¸»é¢˜ç®—æ³•ã€‚ç„¶ååœ¨é¡µé¢ä¸­åŠ ä¸Š`Setting`ç»„ä»¶

```tsx
// src/app/demo/layout.tsx
'use client';
import Theme from '../_components/theme';
import { useAntdAlgorithm } from '../_components/theme/hooks';
// ...

const DemoAntd: FC<PropsWithChildren> = ({ children }) => {
    // ...
    const algorithm = useAntdAlgorithm();
    return (
        <ConfigProvider
            locale={antdLocaleData}
            theme={{
                algorithm,
                // ...
            }}
        >
            {/* ... */}
        </ConfigProvider>
    );
};

const DemoLayout: FC<PropsWithChildren> = ({ children }) => (
    <LayoutStore>
        <AntdRegistry>
            <Locale>
                <Theme>
                    <DemoAntd>{children}</DemoAntd>
                </Theme>
            </Locale>
        </AntdRegistry>
    </LayoutStore>
);
export default DemoLayout;
```

æ·»åŠ ä¸€ä¸ªæ¼”ç¤ºï¼Œå¹¶åŠ å…¥é¡µé¢ä¸­æŸ¥çœ‹æ•ˆæœ

```tsx
// src/app/_components/theme/demo.tsx
'use client';
import type { FC } from 'react';
import { Calendar } from 'antd';

import $styles from '../../demo/_components/style.module.css';
import { AntdThemeSetting } from './setting';
const ThemeDemo: FC = () => (
    <div className={$styles.container}>
        <h2 className="tw-text-center">Setting Demo</h2>
        <div className="tw-flex tw-flex-col tw-items-center">
            <div className="tw-mb-5 tw-flex-auto">
                <AntdThemeSetting />
            </div>
            <div className="tw-max-w-md">
                <Calendar fullscreen={false} />
            </div>
        </div>
    </div>
);
export default ThemeDemo;

// src/app/demo/page.tsx
// ...
const DemoPage: FC = () => (
    <div className={$styles.demo}>
        <ThemeDemo />
    </div>
);

export default DemoPage;
```

![](https://cn-nb1.rains3.com/3rcd/media/1735680125717.gif)

### åˆ‡æ¢Shadcn

ç”±äºshadcnå’Œtailwindçš„ä¸»é¢˜åˆ¤æ–­æ˜¯ä¸€è‡´çš„ï¼Œæˆ‘ä»¬éƒ½è®¾å®šäº†é€šè¿‡`html`çš„`class`åˆ¤æ–­ï¼Œæ‰€ä»¥éå¸¸ç®€å•

å®‰è£…shadcnçš„`dropdown-menu`ç»„ä»¶

```bash
pnpm addsc dropdown-menu
```

æˆ‘ä»¬å…ˆä¿®æ”¹ä¸€ä¸‹å‰å°é¡µé¢çš„css

```css
/* src/app/(pages)/layout.module.css */
.layout {
    /* ... */
}

html[class='dark'] .layout {
    @apply tw-bg-[url(../styles/images/bg-dark.png)];
}
```

å¢åŠ ä¸€ä¸ª`global.css`ç¼–å†™ä¸€äº›é¢œè‰²ç›¸å…³çš„`body`æ ·å¼

```css
/* src/app/(pages)/global.css */
body {
    color: hsl(var(--foreground));
    background-color: hsl(var(--background));
}
```

åœ¨å¸ƒå±€ä¸­å¯¼å…¥è¯¥cssæ–‡ä»¶

```tsx
// src/app/(pages)/layout.tsx
// ...
import './global.css';
```

ç¼–å†™è®¾ç½®ç»„ä»¶

è¯·åŠ¡å¿…åŠ ä¸Š`modal={false}`ï¼Œä»¥é˜²æ­¢ç‚¹å‡»ä¸‹æ‹‰èœå•é¡µé¢å˜å…¨å±

```tsx
// src/app/_components/theme/setting.tsx
// ...
import { Button } from '../shadcn/ui/button';
import {
    DropdownMenu,
    DropdownMenuContent,
    DropdownMenuItem,
    DropdownMenuTrigger,
} from '../shadcn/ui/dropdown-menu';

/**
 * Shadcnä¸»é¢˜é€‰æ‹©å™¨
 */
export const ShadcnThemeSetting: FC = () => {
    const { changeMode } = useThemeActions();
    return (
        <DropdownMenu modal={false}>
            <DropdownMenuTrigger asChild>
                <Button variant="outline" size="icon" className="focus-visible:!tw-ring-0">
                    <Sun className="tw-h-[1.2rem] tw-w-[1.2rem] tw-rotate-0 tw-scale-100 tw-transition-all dark:tw--rotate-90 dark:tw-scale-0" />
                    <Moon className="tw-absolute tw-h-[1.2rem] tw-w-[1.2rem] tw-rotate-90 tw-scale-0 tw-transition-all dark:tw-rotate-0 dark:tw-scale-100" />
                    <span className="tw-sr-only">Toggle theme</span>
                </Button>
            </DropdownMenuTrigger>
            <DropdownMenuContent align="end">
                <DropdownMenuItem onClick={() => changeMode('light')}>Light</DropdownMenuItem>
                <DropdownMenuItem onClick={() => changeMode('dark')}>Dark</DropdownMenuItem>
                <DropdownMenuItem onClick={() => changeMode('system')}>System</DropdownMenuItem>
            </DropdownMenuContent>
        </DropdownMenu>
    );
};
```

åœ¨å¸ƒå±€çš„`Header`ä¸­å¯¼å…¥ç»„ä»¶

```tsx
// src/app/_components/header/index.tsx
// ...
import $styles from './styles.module.css';

export const Header: FC = () => (
    <header className={$styles.header}>
        <HeaderLogo />
        <div className="tw-mt-5">
            <ShadcnThemeSetting />
        </div>
    </header>
);
```

ä¿®æ”¹ä¸€ä¸‹`Header`çš„æ ·å¼

```css
/* src/app/_components/header/styles.module.css */
.header {
    @apply tw-flex tw-items-center tw-pt-6 tw-max-h-24 tw-flex-auto tw-flex-col tw-mb-3;
}
```

çœ‹ä¸€ä¸‹æ•ˆæœ

![](https://cn-nb1.rains3.com/3rcd/media/1735751847184.gif)

### å…¶å®ƒè¯´æ˜

å¦‚æœä¸éœ€è¦ä½¿ç”¨antdï¼Œé‚£ä¹ˆï¼Œç›´æ¥ä½¿ç”¨[next-themes](https://github.com/pacocoursey/next-themes)ä¹Ÿæ˜¯ä¸ªä¸é”™çš„é€‰æ‹©ã€‚ä½†è¿™ä¸ªå·¥å…·ä¸å¤§çµæ´»ï¼Œæˆ‘ä»¬ç»“åˆzustandè‡ªå·±å†™å‡ºæ¥å°±æ›´åŠ å®¹æ˜“æŠŠæ§äº†ï¼Œä¹Ÿèƒ½æ›´æ·±å…¥çš„å­¦ä¹ reactçŠ¶æ€ç®¡ç†çš„ä¸€äº›ç›¸å…³çŸ¥è¯†ï¼
